define(["angular","lodash","cjt/util/locale","uiBootstrap","cjt/decorators/paginationDecorator","cjt/directives/toggleSortDirective","cjt/directives/pageSizeDirective","cjt/directives/validationItemDirective","cjt/directives/spinnerDirective","cjt/directives/autoFocus","cjt/filters/wrapFilter","cjt/filters/breakFilter","app/services/domainService","cjt/decorators/growlDecorator"],function(angular,_,LOCALE,growl){var app=angular.module("App");var _updateStatus=function(list,updates){for(var i=0,l=list.length;i<l;i++){var update=_findUpdateByDomain(updates,list[i].domain);if(update){list[i].enabled=update.enabled;if(update.exception){list[i].exception=update.exception}else{delete list[i].exception}}else{if(list[i].exception){delete list[i].exception}}}};var _findUpdateByDomain=function(updates,domain){for(var i=0,l=updates.length;i<l;i++){if(updates[i].domain===domain){return updates[i]}}return};var controller=app.controller("domainListController",["$scope","$routeParams","$q","DomainService","spinnerAPI","growl",function($scope,$routeParams,$q,DomainService,spinnerAPI,growl){var _initializeScope=function(){$scope.activeSearch=false;$scope.filteredData=false;$scope.totalEnabled=0;$scope.totalDisabled=0;$scope.selectedRow=-1;$scope.isEnabled=PAGE.enabled;$scope.hasFeature=PAGE.hasFeature;if(!$scope.hasFeature){return}$scope.domainList=[];$scope.totalPages=0;$scope.totalItems=0;$scope.meta={filterBy:$routeParams.filterBy||"*",filterCompare:$routeParams.filterCompare||"contains",filterValue:$routeParams.filterValue||"",pageSize:$routeParams.pageSize||20,pageNumber:$routeParams.pageNumber||1,sortDirection:$routeParams.sortDirection||"asc",sortBy:$routeParams.sortBy||"domain",sortType:$routeParams.sortType,pageSizes:[20,50,100],start:0,limit:0}};$scope.allDomainsAreDisabled=function(){return $scope.totalDisabled===$scope.totalItems};$scope.allDomainsAreEnabled=function(){return $scope.totalEnabled===$scope.totalItems};$scope.hasNoDomains=function(){return $scope.totalItems===0};$scope.clearFilter=function(){$scope.meta.filterValue="";$scope.activeSearch=false;$scope.filteredData=false;$scope.selectedRow=-1;return $scope.fetch()};$scope.startFilter=function(){$scope.activeSearch=true;$scope.filteredData=false;$scope.selectedRow=-1;var defer=$q.defer();defer.promise.then(function(){$scope.selectPage(1)}).then(function(){$scope.filteredData=true});defer.resolve()};$scope.toggleRow=function($event,index){$event.preventDefault();if(index===$scope.selectedRow){$scope.selectedRow=-1}else{$scope.selectedRow=index}};$scope.selectPageSize=function(){$scope.selectPage(1)};$scope.selectPage=function(page){$scope.selectedRow=-1;if(page&&angular.isNumber(page)){$scope.meta.pageNumber=page}return $scope.fetch()};$scope.sortList=function(meta,defaultSort){$scope.selectedRow=-1;if(!defaultSort){$scope.fetch()}};$scope.triggerToggleSearch=function(event){if(event.keyCode===27){$scope.toggleSearch(true)}if(event.keyCode===13){$scope.toggleSearch()}};$scope.toggleSearch=function(isClick){var filter=$scope.meta.filterValue;if(!filter&&($scope.activeSearch||$scope.filteredData)){$scope.clearFilter()}else if(isClick&&$scope.activeSearch){$scope.clearFilter()}else if(filter){$scope.startFilter()}};$scope.fetch=function(){spinnerAPI.start("loadingSpinner");return DomainService.fetchList($scope.meta).then(function(results){$scope.domainList=results.items;$scope.totalItems=results.totalItems;$scope.totalPages=results.totalPages;$scope.totalEnabled=results.totalEnabled;$scope.totalDisabled=results.totalDisabled;$scope.meta.start=($scope.meta.pageNumber-1)*$scope.meta.pageSize+1;$scope.meta.limit=$scope.meta.pageNumber*$scope.meta.pageSize;if($scope.meta.limit>$scope.totalItems){$scope.meta.limit=$scope.totalItems}if($scope.meta.limit===0){$scope.meta.start=0}},function(error){growl.error(error)}).then(function(){spinnerAPI.stop("loadingSpinner")})};$scope.setDomain=function(domain){spinnerAPI.start("loadingSpinner");if(domain.enabled){return DomainService.enableDomains(domain.domain).then(function(result){$scope.totalEnabled++;$scope.totalDisabled--;growl.success(LOCALE.maketext("Successfully enabled [asis,Greylisting] on “[output,class,_1,nobreak]”.",result.items[0].domain))},function(results){growl.error(results.error)}).then(function(){spinnerAPI.stop("loadingSpinner")})}else{return DomainService.disableDomains(domain.domain).then(function(result){$scope.totalDisabled++;$scope.totalEnabled--;growl.success(LOCALE.maketext("Successfully disabled [asis,Greylisting] on “[output,class,_1,nobreak]”.",result.items[0].domain))},function(results){growl.error(results.error)}).then(function(){spinnerAPI.stop("loadingSpinner")})}};$scope.enableAllDomains=function($event){if($scope.allDomainsAreEnabled()){return}spinnerAPI.start("loadingSpinner");return DomainService.enableAllDomains().then(function(results){_updateStatus($scope.domainList,results.items);$scope.totalItems=results.totalItems;$scope.totalPages=results.totalPages;$scope.totalEnabled=results.totalItems;$scope.totalDisabled=0;growl.success(LOCALE.maketext("Successfully enabled [asis,Greylisting] on all domains."))},function(results){growl.error(results.error)}).then(function(){spinnerAPI.stop("loadingSpinner")})};$scope.disableAllDomains=function($event){if($scope.allDomainsAreDisabled()){return}spinnerAPI.start("loadingSpinner");return DomainService.disableAllDomains().then(function(results){_updateStatus($scope.domainList,results.items);$scope.totalItems=results.totalItems;$scope.totalPages=results.totalPages;$scope.totalDisabled=results.totalItems;$scope.totalEnabled=0;growl.success(LOCALE.maketext("Successfully disabled [asis,Greylisting] on all domains."))},function(results){growl.error(results.error)}).finally(function(){spinnerAPI.stop("loadingSpinner")})};$scope.hasDisabledDomains=function(){return $scope.totalDisabled>0};var _initializeView=function(){if(app.firstLoad.domainList&&PAGE.domainList){app.firstLoad.domainList=false;var results=DomainService.prepareList(PAGE.domainList);$scope.meta.pageNumber=1;$scope.domainList=results.items;$scope.totalItems=results.totalItems;$scope.totalPages=results.totalPages;$scope.totalEnabled=PAGE.domainList.meta.cPGreyList.total_enabled;$scope.totalDisabled=PAGE.domainList.meta.cPGreyList.total_disabled;$scope.meta.start=($scope.meta.pageNumber-1)*$scope.meta.pageSize+1;$scope.meta.limit=$scope.meta.pageNumber*$scope.meta.pageSize;if($scope.meta.limit>$scope.totalItems){$scope.meta.limit=$scope.totalItems}if($scope.meta.limit===0){$scope.meta.start=0}}else{$scope.selectPage(1)}};_initializeScope();$scope.$watch("meta.filterValue",function(oldValue,newValue){if(oldValue===newValue){return}$scope.activeSearch=false});_initializeView()}]);return controller});