define("app/services/domainService",["angular","lodash","cjt/util/locale","cjt/io/api","cjt/io/uapi-request","cjt/io/uapi","cjt/services/APIService"],function(e,t,a,i,n){var r=e.module("App");r.factory("DomainService",["$q","APIService",function(a,i){function r(e){var a=[];if(e.data){for(var i=e.data,n=0,r=i.length;r>n;n++)a.push(i[n]);var o=e.meta,l=o.paginate.total_records||i.length,s=o.paginate.total_pages||1,c=0,d=0;if(o.hasOwnProperty("cPGreyList"))c=o.cPGreyList.total_enabled,d=o.cPGreyList.total_disabled;else{var m=t.filter(i,function(e){return!!e.enabled});c=m?m.length:0,d=i.length-c}return{items:a,totalItems:l,totalPages:s,totalEnabled:c,totalDisabled:d}}return{items:[],totalItems:0,totalPages:0,totalEnabled:0,totalDisabled:0}}function o(e,t){var a=new n.Class;a.initialize("cPGreyList",e,{domains:t});var i=this.deferred(a,{done:function(e,t){e=e.parsedResponse;var a=r(e);e.status?t.resolve(a):t.reject({items:a.items,error:e.error})}});return i.promise}function l(e){var t=new n.Class;t.initialize("cPGreyList",e);var a=this.deferred(t,{done:function(e,t){e=e.parsedResponse;var a=r(e);e.status?t.resolve(a):(a.error=e.error,t.reject(a))}});return a.promise}var s=function(){};return s.prototype=new i,e.extend(s.prototype,{fetchList:function(e){var t=new n.Class;t.initialize("cPGreyList","list_domains"),e&&(e.sortBy&&e.sortDirection&&t.addSorting(e.sortBy,e.sortDirection,e.sortType),e.pageNumber&&t.addPaging(e.pageNumber,e.pageSize||10),e.filterBy&&e.filterCompare&&e.filterValue&&t.addFilter(e.filterBy,e.filterCompare,e.filterValue));var a=this.deferred(t,{transformAPISuccess:r});return a.promise},prepareList:function(e){return r(e)},enableDomains:function(e){return o.call(this,"enable_domains",e)},enableAllDomains:function(){return l.call(this,"enable_all_domains")},disableDomains:function(e){return o.call(this,"disable_domains",e)},disableAllDomains:function(){return l.call(this,"disable_all_domains")}}),new s}])}),define("app/views/domains",["angular","lodash","cjt/util/locale","uiBootstrap","cjt/decorators/paginationDecorator","cjt/directives/toggleSortDirective","cjt/directives/pageSizeDirective","cjt/directives/validationItemDirective","cjt/directives/spinnerDirective","cjt/directives/autoFocus","cjt/filters/wrapFilter","cjt/filters/breakFilter","app/services/domainService","cjt/decorators/growlDecorator"],function(e,t,a){var i=e.module("App"),n=function(e,t){for(var a=0,i=e.length;i>a;a++){var n=r(t,e[a].domain);n?(e[a].enabled=n.enabled,n.exception?e[a].exception=n.exception:delete e[a].exception):e[a].exception&&delete e[a].exception}},r=function(e,t){for(var a=0,i=e.length;i>a;a++)if(e[a].domain===t)return e[a]},o=i.controller("domainListController",["$scope","$routeParams","$q","DomainService","spinnerAPI","growl",function(t,r,o,l,s,c){var d=function(){t.activeSearch=!1,t.filteredData=!1,t.totalEnabled=0,t.totalDisabled=0,t.selectedRow=-1,t.isEnabled=PAGE.enabled,t.hasFeature=PAGE.hasFeature,t.hasFeature&&(t.domainList=[],t.totalPages=0,t.totalItems=0,t.meta={filterBy:r.filterBy||"*",filterCompare:r.filterCompare||"contains",filterValue:r.filterValue||"",pageSize:r.pageSize||20,pageNumber:r.pageNumber||1,sortDirection:r.sortDirection||"asc",sortBy:r.sortBy||"domain",sortType:r.sortType,pageSizes:[20,50,100],start:0,limit:0})};t.allDomainsAreDisabled=function(){return t.totalDisabled===t.totalItems},t.allDomainsAreEnabled=function(){return t.totalEnabled===t.totalItems},t.hasNoDomains=function(){return 0===t.totalItems},t.clearFilter=function(){return t.meta.filterValue="",t.activeSearch=!1,t.filteredData=!1,t.selectedRow=-1,t.fetch()},t.startFilter=function(){t.activeSearch=!0,t.filteredData=!1,t.selectedRow=-1;var e=o.defer();e.promise.then(function(){t.selectPage(1)}).then(function(){t.filteredData=!0}),e.resolve()},t.toggleRow=function(e,a){e.preventDefault(),t.selectedRow=a===t.selectedRow?-1:a},t.selectPageSize=function(){t.selectPage(1)},t.selectPage=function(a){return t.selectedRow=-1,a&&e.isNumber(a)&&(t.meta.pageNumber=a),t.fetch()},t.sortList=function(e,a){t.selectedRow=-1,a||t.fetch()},t.triggerToggleSearch=function(e){27===e.keyCode&&t.toggleSearch(!0),13===e.keyCode&&t.toggleSearch()},t.toggleSearch=function(e){var a=t.meta.filterValue;a||!t.activeSearch&&!t.filteredData?e&&t.activeSearch?t.clearFilter():a&&t.startFilter():t.clearFilter()},t.fetch=function(){return s.start("loadingSpinner"),l.fetchList(t.meta).then(function(e){t.domainList=e.items,t.totalItems=e.totalItems,t.totalPages=e.totalPages,t.totalEnabled=e.totalEnabled,t.totalDisabled=e.totalDisabled,t.meta.start=(t.meta.pageNumber-1)*t.meta.pageSize+1,t.meta.limit=t.meta.pageNumber*t.meta.pageSize,t.meta.limit>t.totalItems&&(t.meta.limit=t.totalItems),0===t.meta.limit&&(t.meta.start=0)},function(e){c.error(e)}).then(function(){s.stop("loadingSpinner")})},t.setDomain=function(e){return s.start("loadingSpinner"),e.enabled?l.enableDomains(e.domain).then(function(e){t.totalEnabled++,t.totalDisabled--,c.success(a.maketext("Successfully enabled [asis,Greylisting] on “[output,class,_1,nobreak]”.",e.items[0].domain))},function(e){c.error(e.error)}).then(function(){s.stop("loadingSpinner")}):l.disableDomains(e.domain).then(function(e){t.totalDisabled++,t.totalEnabled--,c.success(a.maketext("Successfully disabled [asis,Greylisting] on “[output,class,_1,nobreak]”.",e.items[0].domain))},function(e){c.error(e.error)}).then(function(){s.stop("loadingSpinner")})},t.enableAllDomains=function(){return t.allDomainsAreEnabled()?void 0:(s.start("loadingSpinner"),l.enableAllDomains().then(function(e){n(t.domainList,e.items),t.totalItems=e.totalItems,t.totalPages=e.totalPages,t.totalEnabled=e.totalItems,t.totalDisabled=0,c.success(a.maketext("Successfully enabled [asis,Greylisting] on all domains."))},function(e){c.error(e.error)}).then(function(){s.stop("loadingSpinner")}))},t.disableAllDomains=function(){return t.allDomainsAreDisabled()?void 0:(s.start("loadingSpinner"),l.disableAllDomains().then(function(e){n(t.domainList,e.items),t.totalItems=e.totalItems,t.totalPages=e.totalPages,t.totalDisabled=e.totalItems,t.totalEnabled=0,c.success(a.maketext("Successfully disabled [asis,Greylisting] on all domains."))},function(e){c.error(e.error)}).finally(function(){s.stop("loadingSpinner")}))},t.hasDisabledDomains=function(){return t.totalDisabled>0};var m=function(){if(i.firstLoad.domainList&&PAGE.domainList){i.firstLoad.domainList=!1;var e=l.prepareList(PAGE.domainList);t.meta.pageNumber=1,t.domainList=e.items,t.totalItems=e.totalItems,t.totalPages=e.totalPages,t.totalEnabled=PAGE.domainList.meta.cPGreyList.total_enabled,t.totalDisabled=PAGE.domainList.meta.cPGreyList.total_disabled,t.meta.start=(t.meta.pageNumber-1)*t.meta.pageSize+1,t.meta.limit=t.meta.pageNumber*t.meta.pageSize,t.meta.limit>t.totalItems&&(t.meta.limit=t.totalItems),0===t.meta.limit&&(t.meta.start=0)}else t.selectPage(1)};d(),t.$watch("meta.filterValue",function(e,a){e!==a&&(t.activeSearch=!1)}),m()}]);return o}),define("app/index",["angular","jquery","lodash","cjt/core","cjt/modules","ngRoute","uiBootstrap"],function(e,t,a,i){return function(){e.module("App",["ngRoute","ui.bootstrap","angular-growl","cjt2.cpanel"]);var t=require(["cjt/bootstrap","cjt/views/applicationController","app/views/domains"],function(t){var a=e.module("App");a.firstLoad={domainList:!0},a.config(["$routeProvider","growlProvider",function(e){e.when("/domains/",{controller:"domainListController",templateUrl:i.buildFullPath("mail/greylisting/views/domains.ptt")}),e.otherwise({redirectTo:"/domains/"})}]),t("#content","App")});return t}});