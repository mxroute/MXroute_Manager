define(["angular","cjt/io/uapi","cjt/io/uapi-request","cjt/util/locale"],function(angular,API,APIREQUEST,LOCALE){var HTML_INFINITY="&infin;";var app;try{app=angular.module("cpanel.mail.Pops")}catch(e){app=angular.module("cpanel.mail.Pops",[])}app.factory("emailAccountsService",["$q","APIService",function($q,APIService){var servicePrototype=new APIService({transformAPISuccess:function(response){return response.data}});var EmailAccountsService=function(){};EmailAccountsService.prototype=servicePrototype;angular.extend(EmailAccountsService.prototype,{_dataWrapper:function(apiCall){return this.deferred(apiCall).promise},addEmailAccount:function(emailAccount){var apiCall=new APIREQUEST.Class;apiCall.initialize("Email","add_pop",emailAccount);apiCall.addAnalytics();return this._dataWrapper(apiCall)},isSharedAddressBookEnabled:function(){var apiCall=new APIREQUEST.Class;apiCall.initialize("DAV","has_shared_global_addressbook");return this._dataWrapper(apiCall)},enableSharedAddressBook:function(){var apiCall=new APIREQUEST.Class;apiCall.initialize("DAV","enable_shared_global_addressbook");return this._dataWrapper(apiCall)},disableSharedAddressBook:function(){var apiCall=new APIREQUEST.Class;apiCall.initialize("DAV","disable_shared_global_addressbook");return this._dataWrapper(apiCall)},changePassword:function(email,domain,password){var apiCall=new APIREQUEST.Class;apiCall.initialize("Email","passwd_pop",{email:email,domain:domain,password:password});return this._dataWrapper(apiCall)},changeQuota:function(email,domain,quota){var apiCall=new APIREQUEST.Class;apiCall.initialize("Email","edit_pop_quota",{email:email,domain:domain,quota:quota});return this._dataWrapper(apiCall)},deleteEmailAccount:function(email,domain){var apiCall=new APIREQUEST.Class;apiCall.initialize("Email","delete_pop",{email:email,domain:domain});return this._dataWrapper(apiCall)},getEmailAccounts:function(apiParams){if(this.currentGetRequest&&this.currentGetRequest.jqXHR){this.currentGetRequest.jqXHR.abort()}var apiCall=new APIREQUEST.Class;if(!apiParams){apiParams={}}apiParams.no_human_readable_keys=1;apiParams.get_restrictions=1;apiCall.initialize("Email","list_pops_with_disk",apiParams);var deferred=$q.defer();var service=this;this.currentGetRequest=new APIService.AngularAPICall(apiCall,{done:function(response){service.currentGetRequest=undefined;if(response.parsedResponse.error){deferred.reject(response.parsedResponse.error)}else{var result=response.parsedResponse;var rdata=result.data;for(var rd=0;rd<rdata.length;rd++){var emailAccount=rdata[rd];emailAccount.diskused=parseInt(emailAccount.diskused,10);emailAccount.humandiskused=LOCALE.format_bytes(emailAccount._diskused);if(emailAccount._diskquota===0||emailAccount.diskquota===0||emailAccount.diskquota==="unlimited"){emailAccount.diskquota=0;emailAccount.humandiskquota=HTML_INFINITY;emailAccount.diskusedpercent=0}else{emailAccount.diskquota=parseInt(emailAccount._diskquota,10)/1024/1024;emailAccount.humandiskquota=LOCALE.format_bytes(emailAccount._diskquota);emailAccount.diskusedpercent=(emailAccount._diskused/emailAccount._diskquota*100).toFixed(2)}emailAccount.humandiskusedpercent=LOCALE.numf(emailAccount.diskusedpercent)+"%";emailAccount.suspended_login=""+emailAccount.suspended_login==="1";emailAccount.suspended_incoming=""+emailAccount.suspended_incoming==="1";emailAccount.suspended_outgoing=""+emailAccount.suspended_outgoing==="1";emailAccount.hold_outgoing=""+emailAccount.hold_outgoing==="1";emailAccount.has_suspended=""+emailAccount.has_suspended==="1"}deferred.resolve(result)}},fail:function(){service.currentGetRequest=undefined}});return deferred.promise},getDefaultAccountUsage:function(){var apiCall=new APIREQUEST.Class;apiCall.initialize("Email","get_main_account_disk_usage");return this._dataWrapper(apiCall)},_createAPICall:function(method,email,messages){var apiCall=new APIREQUEST.Class;apiCall.initialize("Email",method,{email:email});return this._dataWrapper(apiCall).then(function(){return messages.success?{method:method,type:"success",message:LOCALE.makevar(messages.success,email),autoClose:1e4}:{method:method,type:"success"}},function(error){return messages.error?{method:method,type:"danger",message:LOCALE.makevar(messages.error,email,error)}:{method:method,type:"danger"}})},getHeldMessageCount:function(email){var apiCall=new APIREQUEST.Class;apiCall.initialize("Email","get_held_message_count",{email:email});return this._dataWrapper(apiCall)},deleteHeldMessages:function(email,releaseAfterDelete){var apiCall=new APIREQUEST.Class;apiCall.initialize("Email","delete_held_messages",{email:email,release_after_delete:releaseAfterDelete});return this._dataWrapper(apiCall)},changeSuspensions:function(emailAccount,suspensions){var calls=[];if(emailAccount.suspended_login&&!suspensions.login){calls.push(this._createAPICall("unsuspend_login",emailAccount.email,{success:LOCALE.translatable("You have removed the suspension on “[_1]” from logging in."),error:LOCALE.translatable("Failed to remove the suspension on “[_1]” from logging in: [_2]")}))}else if(!emailAccount.suspended_login&&suspensions.login){calls.push(this._createAPICall("suspend_login",emailAccount.email,{success:LOCALE.translatable("You have suspended “[_1]” from logging in."),error:LOCALE.translatable("Failed to suspend “[_1]” from logging in: [_2]")}))}if(emailAccount.suspended_incoming&&!suspensions.incoming){calls.push(this._createAPICall("unsuspend_incoming",emailAccount.email,{success:LOCALE.translatable("You have removed the suspension on “[_1]” from receiving mail."),error:LOCALE.translatable("Failed to remove the suspension on “[_1]” from receiving mail: [_2]")}))}else if(!emailAccount.suspended_incoming&&suspensions.incoming){calls.push(this._createAPICall("suspend_incoming",emailAccount.email,{success:LOCALE.translatable("You have suspended “[_1]” from receiving mail."),error:LOCALE.translatable("Failed to suspend “[_1]” from receiving mail: [_2]")}))}if(emailAccount.suspended_outgoing&&suspensions.outgoing!=="suspend"){calls.push(this._createAPICall("unsuspend_outgoing",emailAccount.email,{success:suspensions.outgoing==="hold"?undefined:LOCALE.translatable("You have removed the suspension on “[_1]” from sending mail."),error:LOCALE.translatable("Failed to remove the suspension on “[_1]” from sending mail: [_2]")}))}else if(!emailAccount.suspended_outgoing&&suspensions.outgoing==="suspend"){calls.push(this._createAPICall("suspend_outgoing",emailAccount.email,{success:LOCALE.translatable("You have suspended “[_1]” from sending mail."),error:LOCALE.translatable("Failed to suspend “[_1]” from sending mail: [_2]")}))}if(emailAccount.hold_outgoing&&suspensions.outgoing!=="hold"){calls.push(this._createAPICall("release_outgoing",emailAccount.email,{success:suspensions.outgoing==="suspend"?undefined:LOCALE.translatable("You have released outgoing mail for “[_1]”."),error:LOCALE.translatable("Failed to release outgoing mail for “[_1]”: [_2]")}))}else if(!emailAccount.hold_outgoing&&suspensions.outgoing==="hold"){calls.push(this._createAPICall("hold_outgoing",emailAccount.email,{success:LOCALE.translatable("You have held “[_1]”’s outgoing mail in the mail queue."),error:LOCALE.translatable("Failed to hold “[_1]”’s outgoing mail in the mail queue: [_2]")}))}if(calls.length>0){return $q.all(calls)}else{return $q(function(resolve){resolve([])})}}});return new EmailAccountsService}])});