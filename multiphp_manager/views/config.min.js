define(["angular","cjt/util/locale","lodash","uiBootstrap","cjt/services/alertService","cjt/directives/alert","cjt/directives/alertList","app/services/configService","app/views/impactedDomainsPopup"],function(angular,LOCALE,_){"use strict";var app=angular.module("App");var controller=app.controller("config",["$scope","configService","$uibModal","$timeout","alertService",function($scope,configService,$uibModal,$timeout,alertService){$scope.loadingVhostList=false;$scope.phpVersionsEmpty=true;$scope.selectedVersion={};$scope.phpVhostList=[];$scope.restrictedPhp={domainsSelected:[],showAlert:false,alertInfo:"",showAllDomains:false,showMore:true};$scope.vhostSelected=false;var selectedVhostList=[];$scope.totalSelectedDomains=0;$scope.checkdropdownOpen=false;$scope.meta={sortReverse:false,sortBy:"vhost",sortDirection:"asc",filterBy:"*",filterCompare:"contains",filterValue:"",maxPages:0,totalItems:$scope.phpVhostList.length,currentPage:1,pageSize:10,pageSizes:[10,20,50,100],start:0,limit:10};var impactedDomains={loading:false,warn:false,show:false,showMore:false,text:""};var getSelectedRestrictedDomains=function(){var totalRestricted=[];$scope.phpVhostList.forEach(function(item){if(item.rowSelected&&item.isRestricted){totalRestricted.push(item.vhost)}});return totalRestricted};var updatePhpAlert=function(){$scope.restrictedPhp.domainsSelected=getSelectedRestrictedDomains();$scope.restrictedPhp.showMore=6<$scope.restrictedPhp.domainsSelected.length;var restrictedDomains=$scope.restrictedPhp.domainsSelected;if(restrictedDomains.length>0){$scope.restrictedPhp.showAlert=true;var phpVersions=$scope.phpVersions.reduce(function(acc,item){if(item.version!=="inherit"){acc.push(item.displayPhpVersion)}return acc},[]);$scope.restrictedPhp.alertInfo=LOCALE.maketext("The system administrator only allows this account to use the [asis,PHP] [numerate,_2,version,versions] [list_and,_1].",phpVersions,phpVersions.length)+" "+LOCALE.maketext("If you change the [asis,PHP] version for the following [numerate,_1,domain,domains], you cannot use this interface to change the [numerate,_1,domain,domains] back to use [numerate,_1,its,their] original version of [asis,PHP].",restrictedDomains.length)}else{$scope.restrictedPhp.showAlert=false}};$scope.selectAllVhosts=function(){if($scope.allRowsSelected){$scope.phpVhostList.forEach(function(item){item.rowSelected=true;if(selectedVhostList.indexOf(item.vhost)!==-1){return}selectedVhostList.push(item.vhost)})}else{var unselectedDomains=$scope.phpVhostList.map(function(item){item.rowSelected=false;return item.vhost});selectedVhostList=_.difference(selectedVhostList,unselectedDomains);$scope.restrictedPhp.showAlert=false}$scope.totalSelectedDomains=selectedVhostList.length;$scope.vhostSelected=$scope.totalSelectedDomains>0;$scope.restrictedPhp.domainsSelected=getSelectedRestrictedDomains();if($scope.restrictedPhp.showAlert){updatePhpAlert()}};var processImpactedDomains=function(vhostInfo,selected){if(selected){vhostInfo.impactedDomains.loading=true;configService.fetchImpactedDomains("domain",vhostInfo.vhost).then(function(result){var domains=_.without(result.data.domains,vhostInfo.vhost);if(result.status&&domains.length>0){vhostInfo.impactedDomains.show=vhostInfo.impactedDomains.warn=vhostInfo.rowSelected;vhostInfo.impactedDomains.showMore=domains.length>10;vhostInfo.impactedDomains.text=LOCALE.maketext("A change to the “[output,strong,_1]” domain‘s PHP version affects the following domains:",vhostInfo.vhost);vhostInfo.impactedDomains.domains=_.sortBy(domains)}},function(error){alertService.add({type:"danger",message:error,closeable:true,replace:false,group:"multiphpManager"})}).finally(function(){vhostInfo.impactedDomains.loading=false})}else{vhostInfo.impactedDomains.show=vhostInfo.impactedDomains.warn=selected}};$scope.toggleRestrictedDomains=function(){$scope.restrictedPhp.showAllDomains=!$scope.restrictedPhp.showAllDomains};$scope.selectVhost=function(vhostInfo){if(typeof vhostInfo!=="undefined"){processImpactedDomains(vhostInfo,vhostInfo.rowSelected);if(vhostInfo.rowSelected){selectedVhostList.push(vhostInfo.vhost);$scope.allRowsSelected=$scope.phpVhostList.every(function(item){return item.rowSelected})}else{selectedVhostList=selectedVhostList.filter(function(item){return item!==vhostInfo.vhost});$scope.allRowsSelected=false}}$scope.totalSelectedDomains=selectedVhostList.length;$scope.vhostSelected=$scope.totalSelectedDomains>0;$scope.restrictedPhp.domainsSelected=getSelectedRestrictedDomains();if($scope.restrictedPhp.showAlert){updatePhpAlert()}};$scope.rowClass=function(vhostInfo){if(vhostInfo.impactedDomains.warn){return"warning"}if(vhostInfo.impactedDomains.loading){return"processing"}};$scope.showAllImpactedDomains=function(vhostInfo){$uibModal.open({templateUrl:"impactedDomainsPopup.ptt",controller:"impactedDomainsPopup",resolve:{data:function(){return vhostInfo}}})};$scope.clearAllSelections=function(event){event.preventDefault();event.stopPropagation();selectedVhostList=[];$scope.phpVhostList.forEach(function(item){item.rowSelected=false});$scope.checkdropdownOpen=false;$scope.allRowsSelected=false;$scope.totalSelectedDomains=0;$scope.vhostSelected=false;$scope.restrictedPhp.showAlert=false};$scope.hidePhpAlert=function(){$scope.restrictedPhp.showAlert=false};var setDomainPhpDropdown=function(versionList){if(typeof versionList!=="undefined"){$scope.phpVersions=versionList;if(typeof $scope.systemPhp!=="undefined"&&$scope.systemPhp!==""){$scope.phpVersions.push({version:"inherit",displayPhpVersion:"inherit"})}}if($scope.phpVersions.length>0){$scope.selectedVersion=$scope.phpVersions[0];$scope.phpVersionsEmpty=false}else{$scope.phpVersionsEmpty=true}};var resetForm=function(){setDomainPhpDropdown();selectedVhostList=[];$scope.phpVhostList.forEach(function(item){item.rowSelected=false});$scope.allRowsSelected=false;$scope.totalSelectedDomains=0;$scope.vhostSelected=false};$scope.performApplyDomainPhp=function(){alertService.clear();if($scope.restrictedPhp.showAlert){$scope.restrictedPhp.showAlert=false}return configService.applyDomainSetting($scope.selectedVersion.version,selectedVhostList).then(function(data){if(typeof data!=="undefined"){alertService.add({type:"success",message:LOCALE.maketext("Successfully applied [asis,PHP] version “[_1]” to the selected [numerate,_2,domain,domains].",$scope.selectedVersion.displayPhpVersion,selectedVhostList.length),closeable:true,replace:false,autoClose:1e4,group:"multiphpManager"});$scope.selectPage()}},function(response){if(typeof response.raw!=="undefined"){var errors=response.raw.errors;if(errors.length>0){var successfulDomains=[];if(response.data&&response.data.vhosts){successfulDomains=response.data.vhosts}errors.forEach(function(error){alertService.add({type:"danger",message:error,closeable:true,replace:false,group:"multiphpManager"})});alertService.add({type:"success",message:LOCALE.maketext("Successfully applied [asis,PHP] version “[_1]” to [numerate,_2,a domain,some domains].",$scope.selectedVersion.displayPhpVersion,successfulDomains.length),closeable:true,replace:false,autoClose:1e4,group:"multiphpManager"})}}else{alertService.add({type:"danger",message:response.error,closeable:true,replace:false,group:"multiphpManager"})}}).finally(function(){resetForm()})};$scope.applyDomainPhp=function(){if($scope.restrictedPhp.domainsSelected.length>0){updatePhpAlert()}else{$scope.performApplyDomainPhp()}};var applyListToTable=function(resultList){var vhostList=resultList.items;$scope.meta.totalItems=resultList.totalItems;var filteredList=vhostList;if($scope.meta.totalItems>_.min($scope.meta.pageSizes)){var start=($scope.meta.currentPage-1)*$scope.meta.pageSize;$scope.showPager=true;$scope.meta.start=start+1;$scope.meta.limit=start+filteredList.length}else{$scope.showPager=false;if(filteredList.length===0){$scope.meta.start=0}else{$scope.meta.start=1}$scope.meta.limit=filteredList.length}var countNonSelected=0;filteredList.forEach(function(item){if(selectedVhostList.indexOf(item.vhost)!==-1){item.rowSelected=true}else{item.rowSelected=false;countNonSelected++}item.impactedDomains=angular.copy(impactedDomains);item.inherited=false;var version_source=item.phpversion_source;if(typeof version_source!=="undefined"){var type="",value="";if(typeof version_source.domain!=="undefined"){type="domain";value=version_source.domain}else if(typeof version_source.system_default!=="undefined"){type="system_default";value=LOCALE.maketext("System Default")}if(type==="domain"&&value!==item.vhost||type==="system_default"){item.inherited=true;item.inheritedInfo=LOCALE.maketext("This domain inherits its [asis,PHP] version “[output,em,_1]” from: [output,strong,_2]",item.displayPhpVersion,value)}}item.isRestricted=false;item.showInheritInfo=false;var installedVersions=PAGE.versionListData.data.versions;if(!_.some(installedVersions,["version",item.version])){item.isRestricted=true}});$scope.restrictedPhp.showMore=6<$scope.restrictedPhp.domainsSelected.length;$scope.phpVhostList=filteredList;$scope.allRowsSelected=filteredList.length>0&&countNonSelected===0};var fetchVhostList=function(){$scope.loadingVhostList=true;return configService.fetchList($scope.meta).then(function(results){applyListToTable(results)},function(error){alertService.add({type:"danger",message:error,closeable:true,replace:false,group:"multiphpManager"})}).then(function(){$scope.loadingVhostList=false})};$scope.selectPage=function(page){if(page&&angular.isNumber(page)){$scope.meta.currentPage=page}return fetchVhostList()};$scope.$on("$viewContentLoaded",function(){alertService.clear();PAGE.versionListData.data.versions=PAGE.versionListData.data.versions.map(function(version){return{version:version,displayPhpVersion:configService.transformPhpFormat(version)}});if(PAGE.vhostListData.status){$scope.loadingVhostList=false;var results=configService.prepareList(PAGE.vhostListData);applyListToTable(results)}else{alertService.add({type:"danger",message:PAGE.vhostListData.errors[0],closeable:true,replace:false,group:"multiphpManager"})}if(PAGE.systemPHPData.status){$scope.systemPhp={version:PAGE.systemPHPData.data.version,displayPhpVersion:configService.transformPhpFormat(PAGE.systemPHPData.data.version)}}else{alertService.add({type:"danger",message:PAGE.systemPHPData.errors[0],closeable:true,replace:false,group:"multiphpManager"})}if(PAGE.versionListData.status){setDomainPhpDropdown(PAGE.versionListData.data.versions)}else{alertService.add({type:"danger",message:PAGE.versionListData.errors[0],closeable:true,replace:false,group:"multiphpManager"})}})}]);return controller});