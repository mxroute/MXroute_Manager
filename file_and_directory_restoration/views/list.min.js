define(["angular","lodash","cjt/util/locale","cjt/services/cpanel/nvDataService","app/services/backupAPI","app/services/backupTypeService","uiBootstrap","cjt/services/alertService","cjt/directives/alert","cjt/directives/alertList"],function(angular,_,LOCALE){"use strict";var app=angular.module("App");app.controller("restoreModalController",["$scope","backupTypeService","$uibModalInstance","fileExists",function($scope,backupTypeService,$uibModalInstance,fileExists){$scope.fileExists=fileExists;$scope.itemType=backupTypeService.getBackupType();$scope.closeModal=function(){$uibModalInstance.close()};$scope.runIt=function(){$uibModalInstance.close(true)}}]);var controller=app.controller("listController",["$scope","backupAPIService","backupTypeService","$uibModal","nvDataService","alertService",function($scope,backupAPIService,backupTypeService,$uibModal,nvDataService,alertService){$scope.buildBreadcrumb=function(){$scope.directoryBreadcrumb=[];var directories=$scope.currentPath.split("/");var parentFolder="/";for(var i=0,length=directories.length;i<length-1;i++){if(i===0){$scope.directoryBreadcrumb.push({folder:parentFolder,path:parentFolder,displayPath:directories[i]})}else{$scope.directoryBreadcrumb.push({folder:parentFolder,path:parentFolder+directories[i]+"/",displayPath:directories[i]});parentFolder=parentFolder+directories[i]+"/"}}};$scope.goHome=function(){if($scope.currentPath!=="/"){$scope.changeDirectory("/")}};$scope.changeDirectory=function(path){$scope.loadingData=true;$scope.backupList=[];var newPath;if(!path){newPath=$scope.directoryBreadcrumb[$scope.directoryBreadcrumb.length-2].path}else{newPath=path}if(newPath.charAt(newPath.length-1)!=="/"){newPath=newPath+"/"}if(newPath.charAt(0)!=="/"){newPath="/"+newPath}$scope.meta.start=($scope.meta.currentPage-1)*$scope.meta.pageSize+1;if(newPath!==$scope.currentPath||$scope.meta.start>$scope.meta.totalItems){$scope.meta.currentPage=1;$scope.meta.start=1}for(var i=0,length=$scope.currentDirectoryContent.length;i<length;i++){if($scope.currentDirectoryContent[i].fullPath===path){$scope.selectedItemExists=$scope.currentDirectoryContent[i].exists;break}}backupAPIService.listDirectory(newPath,$scope.meta.currentPage,$scope.meta.pageSize).then(function(apiResult){$scope.currentPath=newPath;$scope.buildBreadcrumb();$scope.addPaths(apiResult.data);var pagination=apiResult.meta.paginate;$scope.updatePagination(pagination)},function(error){alertService.add({type:"danger",message:error,closeable:true,group:"cpanel-restoration"})}).finally(function(){$scope.loadingData=false})};$scope.changePageSize=function(){nvDataService.setObject({file_restoration_page_size:$scope.meta.pageSize});$scope.changeDirectory($scope.currentPath)};$scope.goToPage=function(pageNumber,currentPath){var pageExists=$scope.checkIfPageExists(pageNumber);if(pageNumber===null||isNaN(pageNumber)){return}else{if(pageExists){$scope.meta.currentPage=parseInt(pageNumber,10);$scope.changeDirectory(currentPath)}else{$scope.pageDoesNotExist=true}}};$scope.setPaginationMessage=function(start,limit,totalItems){if(totalItems===0){start=0;limit=0}$scope.paginationMessage=LOCALE.maketext("Displaying [numf,_1] to [numf,_2] out of [quant,_3,item,items]",start,limit,totalItems)};$scope.updatePagination=function(pagination){$scope.meta.totalItems=parseInt(pagination.total_records);$scope.meta.currentPage=parseInt(pagination.current_page);$scope.meta.pageSize=parseInt(pagination.page_size);if($scope.meta.totalItems<$scope.meta.pageSize){$scope.meta.limit=$scope.meta.totalItems}else{$scope.meta.limit=$scope.meta.currentPage*$scope.meta.pageSize}$scope.setPaginationMessage($scope.meta.start,$scope.meta.limit,$scope.meta.totalItems)};$scope.checkIfPageExists=function(pageNumber){if(pageNumber*$scope.meta.page_size>$scope.meta.total_records){return false}else{return true}};$scope.selectItem=function(item){$scope.selectedItemName=item.parsedName;if(item.type.indexOf("dir")!==-1){$scope.changeDirectory(item.fullPath)}else{$scope.selectedItemExists=item.exists;$scope.loadingData=true;backupAPIService.listBackups(item.fullPath).then(function(itemData){$scope.backupList=itemData}).catch(function(error){alertService.add({type:"danger",message:error,closeable:true,group:"cpanel-restoration"})}).finally(function(){$scope.loadingData=false})}};$scope.getBackupListForDirectory=function(){$scope.selectedItemName=$scope.currentPath;$scope.loadingData=true;backupAPIService.listBackups($scope.currentPath).then(function(response){$scope.backupList=response}).catch(function(error){alertService.add({type:"danger",message:error,closeable:true,group:"cpanel-restoration"})}).finally(function(){$scope.loadingData=false})};$scope.addPaths=function(directories){$scope.currentDirectoryContent=[];for(var i=0,length=directories.length;i<length;i++){directories[i]["path"]=$scope.currentPath;directories[i]["fullPath"]=$scope.currentPath+directories[i].name;directories[i]["parsedName"]=directories[i].name.replace(/\s/g," ");$scope.currentDirectoryContent.push(directories[i])}$scope.meta.totalItems=$scope.currentDirectoryContent.length};$scope.restore=function(backup){$scope.selectedFilePath=backup.path;$scope.selectedBackupID=backup.backupID;backupTypeService.setBackupType(backup.type);var $uibModalInstance=$uibModal.open({templateUrl:"restoreModalContent.tmpl",controller:"restoreModalController",resolve:{fileExists:$scope.selectedItemExists}});$uibModalInstance.result.then(function(proceedRestoration){if(proceedRestoration){$scope.dataRestoring=true;backupAPIService.restore($scope.selectedFilePath,$scope.selectedBackupID).then(function(response){if(response.success){if(backup.type==="file"||backup.type==="symlink"){alertService.add({type:"success",message:LOCALE.maketext("The system successfully restored the “[_1]” backup file from the date “[_2]”.",_.escape($scope.selectedFilePath),_.escape($scope.selectedBackupID)),autoClose:1e4,group:"cpanel-restoration"})}else if(backup.type==="dir"){alertService.add({type:"success",message:LOCALE.maketext("The system successfully restored the “[_1]” backup directory from the date “[_2]”.",_.escape($scope.selectedFilePath),_.escape($scope.selectedBackupID)),autoClose:1e4,group:"cpanel-restoration"})}else{throw"DEVELOPER ERROR: invalid backup type"}}}).catch(function(error){if(backup.type==="file"||backup.type==="symlink"){alertService.add({type:"danger",message:LOCALE.maketext("File restoration failure: [_1]",error),closeable:true,group:"cpanel-restoration"})}else if(backup.type==="dir"){alertService.add({type:"danger",message:LOCALE.maketext("Directory restoration failure: [_1]",error),closeable:true,group:"cpanel-restoration"})}else{throw"DEVELOPER ERROR: invalid backup type"}}).finally(function(){$scope.dataRestoring=false})}})};$scope.init=function(){$scope.currentPath="/";$scope.initialDataLoaded=false;$scope.currentDirectoryContent=[];$scope.meta={showPager:true,maxPages:0,totalItems:0,currentPage:1,pageSize:10,pageSizes:[10,20,50,100],start:1,limit:10};nvDataService.get("file_restoration_page_size").then(function(pairs){$scope.meta.pageSize=pairs[0].value||10;backupAPIService.listDirectory("/",$scope.meta.start,$scope.meta.pageSize).then(function(apiResult){$scope.currentPath="/";$scope.buildBreadcrumb();$scope.addPaths(apiResult.data);var pagination=apiResult.meta.paginate;$scope.updatePagination(pagination)},function(error){$scope.noMetadataError=error}).finally(function(){$scope.initialDataLoaded=true})})};$scope.init()}]);return controller});