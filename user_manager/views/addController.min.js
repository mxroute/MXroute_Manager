define(["angular","lodash","cjt/util/locale","app/views/addEditController","cjt/directives/alertList","cjt/directives/bytesInput","cjt/directives/toggleLabelInfoDirective","cjt/directives/toggleSwitchDirective","cjt/directives/labelSuffixDirective","cjt/services/alertService","app/services/userService","cjt/services/dataCacheService"],function(angular,_,LOCALE,baseCtrlFactory){var app=angular.module("App");var controller=app.controller("addController",["$scope","$routeParams","$timeout","$location","$anchorScroll","userService","alertService","directoryLookupService","dataCache","defaultInfo","quotaInfo","emailDaemonInfo","ftpDaemonInfo","webdiskDaemonInfo","features","spinnerAPI",function($scope,$routeParams,$timeout,$location,$anchorScroll,userService,alertService,directoryLookupService,dataCache,defaultInfo,quotaInfo,emailDaemonInfo,ftpDaemonInfo,webdiskDaemonInfo,features,spinnerAPI){var baseCtrl=baseCtrlFactory($scope,userService,emailDaemonInfo,ftpDaemonInfo,webdiskDaemonInfo,features,defaultInfo,quotaInfo,alertService);var initializeScope=function(){baseCtrl.initializeScope();$scope.ui.user.sendInvite=$scope.ui.isInviteSubEnabled=!!window.PAGE.isInviteSubEnabled};var initializeView=function(){baseCtrl.initializeView()};initializeScope();initializeView();$scope.toggleService=function(service){service.enabled=!service.enabled};$scope.create=function(user,leave){$scope.inProgress=true;alertService.clear();$anchorScroll("btn-create");return userService.create(user).then(function(user){var query;var cachedUserList=dataCache.get("userList");if(cachedUserList){$scope.insertSubAndRemoveDupes(user,cachedUserList);dataCache.set("userList",cachedUserList);query={loadFromCache:true}}else{query={loadFromCache:false}}baseCtrl.clearPrefetch();alertService.add({type:"success",message:LOCALE.maketext("You successfully created the following user: [_1]",user.real_name||user.full_username),id:"createSuccess",autoClose:1e4});if(leave){$scope.loadView("list/rows",query)}else{var lastDomain=$scope.ui.user.domain;initializeScope();$scope.ui.user.domain=lastDomain;$scope.form.$setPristine();$anchorScroll("top");$timeout(function(){var el=angular.element("#full-name");if(el){el.focus()}},10)}},function(error){var name=user.real_name||user.username+"@"+user.domain;error=error.error||error;alertService.add({type:"danger",message:LOCALE.maketext("The system failed to create the “[_1]” user with the following error: [_2]",name,error),id:"createError"});$anchorScroll("top");var cachedUserList=dataCache.get("userList");if(error.user&&cachedUserList){$scope.insertSubAndRemoveDupes(error.user,cachedUserList);dataCache.set("userList",cachedUserList)}baseCtrl.clearPrefetch()}).finally(function(){$scope.inProgress=false})};$scope.$watch("ui.user.services.ftp.homedir",function(){if(!$scope.ui.user.services.ftp.homedir&&$scope.form.txtFtpHomeDirectory&&!$scope.form.txtFtpHomeDirectory.$pristine){$scope.form.txtFtpHomeDirectory.$setViewValue("/")}});$scope.$watch("ui.user.services.webdisk.homedir",function(){if(!$scope.ui.user.services.webdisk.homedir&&$scope.form.txtWebDiskHomeDirectory&&!$scope.form.txtWebDiskHomeDirectory.$pristine){$scope.form.txtWebDiskHomeDirectory.$setViewValue("/")}});$scope.$watch("ui.user.username + '@' + ui.user.domain",function(newValue,oldValue){var parts=newValue.split("@");if(!$scope.ui.user.services.ftp.isCandidate&&$scope.form.txtFtpHomeDirectory&&$scope.form.txtFtpHomeDirectory.$pristine){$scope.ui.user.services.ftp.homedir=$scope.ui.docrootByDomain[parts[1]]+"/"+parts[0]}if(!$scope.ui.user.services.webdisk.isCandidate&&$scope.form.txtWebDiskHomeDirectory&&$scope.form.txtWebDiskHomeDirectory.$pristine){$scope.ui.user.services.webdisk.homedir=$scope.ui.docrootByDomain[parts[1]]+"/"+parts[0]}})}]);return controller});