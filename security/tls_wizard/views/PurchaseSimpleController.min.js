define(["angular","lodash","cjt/util/locale","app/views/Certificate","app/services/CountriesService","cjt/modules","ngSanitize","app/services/CertificatesService","app/services/LocationService","app/services/IdVerDefaults","cjt/directives/cpanel/searchSettingsPanel","cjt/directives/triStateCheckbox","cjt/filters/qaSafeIDFilter","cjt/directives/spinnerDirective","cjt/directives/quickFiltersDirective","cjt/decorators/growlDecorator"],function(angular,_,LOCALE){"use strict";var app=angular.module("App");app.controller("PurchaseSimpleController",["$rootScope","$scope","$controller","$location","$filter","$timeout","$sce","$routeParams","$window","CertificatesService","IdVerDefaults","growl","CountriesService","Certificate","LocationService","SearchSettingsModel",function($rootScope,$scope,$controller,$location,$filter,$timeout,$sce,$routeParams,$window,CertificatesService,IdVerDefaults,growl,COUNTRIES,Certificate,LocationService,SearchSettingsModel){$scope.show_introduction_block=CertificatesService.show_introduction_block;$scope.domains=CertificatesService.get_all_domains(true);$scope.virtual_hosts=CertificatesService.get_virtual_hosts();$scope.pending_certificates=CertificatesService.get_pending_certificates();$scope.showExistingCertificates=false;$scope.selected_domains=[];$scope.working_virtual_host=null;$scope.LOCALE=LOCALE;$scope.resolution_timeout=0;$scope.show_wildcard_domains=true;$scope.cart_items=[];$scope.checkout_mode=false;$scope.missing_base_domains=[];$scope.showAdvancedProductSettings=true;$scope.panels={};$rootScope.addToCartGrowl=null;$scope.COUNTRIES=COUNTRIES;$scope.identity_verification={};var saved_idver=CertificatesService.get_stored_extra_settings().simple_identity_verification;if(saved_idver){IdVerDefaults.restore_previous($scope.identity_verification,saved_idver)}else{IdVerDefaults.set_defaults($scope.identity_verification)}angular.forEach($scope.virtual_hosts,function(virtual_host){virtual_host.reset();virtual_host.show_wildcards=true});CertificatesService.build_wildcard_map();$scope.meta={sortReverse:false,sortBy:"label",sortDirection:"asc",maxPages:5,totalItems:$scope.domains.length,currentPage:1,pageSize:20,pageSizes:[20,50,100,250],start:0,limit:20,filterValue:"",productFilterValue:""};$scope.cart_price_strings=null;var default_search_values={certTerms:{"1_year":true,"2_year":false,"3_year":false}};$scope.searchFilterOptions=new SearchSettingsModel(CertificatesService.get_domain_search_options());$scope.productSearchFilterOptions=new SearchSettingsModel(CertificatesService.get_product_search_options(),default_search_values);$scope.displayProxySubdomains=true;$scope.filter_domains=function(domains){var filtered_domains=domains;if($scope.meta.filterValue){filtered_domains=$filter("filter")(filtered_domains,$scope.meta.filterValue)}filtered_domains=$scope.searchFilterOptions.filter(filtered_domains);return filtered_domains};$scope.filter_products=function(products){var filtered_products=products;var selected_domains=$scope.selected_domains;var wildcard_domains=$filter("filter")(selected_domains,{is_wildcard:true});filtered_products=$filter("filter")(filtered_products,function(product){if(!product.wildcard_price&&wildcard_domains.length){return}else if(!product.price&&selected_domains.length-wildcard_domains.length>0){return}return true});if($scope.meta.productFilterValue){filtered_products=$filter("filter")(filtered_products,$scope.meta.productFilterValue)}filtered_products=$scope.productSearchFilterOptions.filter(filtered_products);return filtered_products};$scope.toggle_values=function(items,att,value){angular.forEach(items,function(item){item[att]=value})};$scope.get_showing_text=function(){return LOCALE.maketext("[output,strong,Showing] [numf,_1] - [numf,_2] of [quant,_3,domain,domains]",$scope.meta.start,$scope.meta.limit,$scope.meta.totalItems)};$scope.get_resolution_text=function(domain){if(domain.resolving){return LOCALE.maketext("Running Domain Control Validation …")}else if(domain.resolved===0){return LOCALE.maketext("Domain Control Validation failed: [_1]",domain.resolution_failure_reason)}else if(domain.resolved===1){if(domain.dcvPassed.dns){var whyNotHttp;if(domain.redirects_count){whyNotHttp=LOCALE.maketext("[asis,HTTP]-based Domain Control Validation required [quant,_1,redirection,redirections].",domain.redirects_count)}else{whyNotHttp=LOCALE.maketext("[asis,HTTP]-based Domain Control Validation failed.")}return LOCALE.maketext("Validated via [asis,DNS]-based Domain Control Validation.")+" ("+whyNotHttp+")"}else{return LOCALE.maketext("Validated via [asis,HTTP]-based Domain Control Validation.")}}};$scope.get_domain_badge_color=function(domain){if(domain.resolving){return"info"}else if(domain.resolved===1){return"success"}else if(domain.resolved===0){return"danger"}return"default"};$scope.get_cert_status_color=function(domain){var cert=$scope.get_domain_certificate(domain.domain).certificate;if(!cert){return}if(domain.certificate_status==="active"&&!cert.is_self_signed){return"label-success"}if(domain.certificate_status==="expired"){return"label-danger"}if(cert.is_self_signed||domain.certificate_status==="expiring_soon"){return"label-warning"}};$scope.select_domain=function(selected_domain){if(selected_domain.selected&&selected_domain.is_wildcard){var covered_domains=$filter("filter")($scope.domains,function(domain){return CertificatesService.compare_wildcard_domain(selected_domain,domain.domain)});$scope.toggle_values(covered_domains,"selected",true)}$scope.update_selected_domains();$scope.check_selected_domains()};$scope.check_selected_domains=function(){if($scope.resolution_timeout){$timeout.cancel($scope.resolution_timeout)}$scope.resolution_timeout=$timeout(function(domains){$scope.ensure_dns(domains)},850,true,CertificatesService.get_all_selected_domains())};$scope.update_selected_domains=function(){$scope.selected_domains=$filter("filter")($scope.domains,function(domain){if(!domain.selected){return false}if($scope.domain_covered_by_wildcard(domain)){return false}return true});$scope.current_certificate.set_domains($scope.selected_domains);$scope.current_certificate.set_virtual_hosts($scope.get_selected_vhosts());$scope.update_baseless_wildcard_domains();$scope.fetch_products();$scope.update_cart_strings()};$scope.get_domain_certificate=function(domain){return CertificatesService.get_domain_certificate(domain)};$scope.get_domain_certificate_type=function(domain){if(domain.certificate_type){return domain.certificate_type}domain.certificate_type="unsecured";var ihost=$scope.get_domain_certificate(domain.domain);if(ihost&&ihost.certificate){if(!ihost.certificate.is_self_signed){domain.certificate_type=ihost.certificate.validation_type}}return $scope.get_domain_certificate_type(domain)};$scope.get_domain_cert_msg=function(domain){if(domain.certificate_status_msg){return domain.certificate_status_msg}var ihost=$scope.get_domain_certificate(domain.domain);var name;if(ihost&&ihost.certificate){var cert=ihost.certificate;if(cert.validation_type==="dv"){name=LOCALE.maketext("A [output,abbr,DV,Domain Validated] certificate already secures this domain.")}else if(cert.validation_type==="ov"){name=LOCALE.maketext("An [output,abbr,OV,Organization Validated] certificate already secures this domain.")}else if(cert.validation_type==="ev"){name=LOCALE.maketext("An [output,abbr,EV,Extended Validation] certificate already secures this domain.")}else if(cert.is_self_signed){name=LOCALE.maketext("A self-signed certificate already secures this domain.")}}if(!name){name=LOCALE.maketext("A certificate of unknown type already secures this domain.")}if(domain.certificate_status==="expired"){name+=" "+LOCALE.maketext("The certificate has expired.")}else if(domain.certificate_status==="expiring_soon"){name+=" "+LOCALE.maketext("It will expire soon.")}domain.certificate_status_msg=name;return $scope.get_domain_cert_msg(domain)};$scope.pending_certificate=function(domain){var result=$scope.pendingCertificateObject(domain);return result?result.order_item_id:false};$scope.pendingCertificateObject=function(domain){var result=false;angular.forEach($scope.pending_certificates,function(pcert){angular.forEach(pcert.vhost_names,function(vhostName){if(vhostName===domain.virtual_host){result=pcert}})});return result};$scope.view_pending_certificate=function(domain){var order_item_id=$scope.pending_certificate(domain);$scope.go_to_pending(order_item_id)};$scope.go_to_pending=function(order_item_id){if(order_item_id){$location.path("/pending-certificates/"+order_item_id)}else{$location.path("/pending-certificates")}};$scope.get_domain_lock_classes=function(domain){var ihost=$scope.get_domain_certificate(domain.domain);if(ihost&&ihost.certificate){if(ihost.certificate.is_self_signed||domain.certificate_status==="expired"){return"grey-padlock"}else{return"green-padlock"}}};$scope.build_csr_url=function(domain){var ihost=$scope.get_virtual_host_certificate(domain);if(ihost&&ihost.certificate){var url="";url+="../../ssl/install.html?id=";url+=encodeURIComponent(ihost.certificate.id);return url}};$scope.get_domain_msg_state=function(domain){var certObj=$scope.pendingCertificateObject(domain);if(certObj){var domainExistsOnCert=CertificatesService.doesDomainMatchOneOf(domain.domain,certObj.domains);if(domainExistsOnCert){return"cert-pending"}else{return"cert-pending-other-domains"}}else if($scope.domain_covered_by_wildcard(domain)){return"covered-by-wildcard"}else{if($scope.get_domain_certificate(domain.domain)&&domain.resolved===-1&&!domain.resolving){return"ssl-exists"}else{return"default"}}};$scope.get_virtual_host_by_display_name=function(vhost_name){var vhost_index=CertificatesService.get_virtual_host_by_display_name(vhost_name);return $scope.virtual_hosts[vhost_index]};$scope.get_virtual_host_certificate=function(domain){return $scope.get_domain_certificate(domain.domain)};$scope.ensure_dns=function(domains){domains=$filter("filter")(domains,{selected:true,resolved:-1});if(!domains.length){return false}var provider_name=$scope.get_current_or_default_provider();return CertificatesService.ensure_domains_can_pass_dcv(domains,provider_name)};$scope.get_current_or_default_provider=function(){var product_obj=$scope.get_product();if(product_obj){var product=$scope.get_product_by_id(product_obj.provider,product_obj.id);if(product){return product.provider_name}}return CertificatesService.get_default_provider_name()};$scope.get_dcv_class=function(domain){var classes=[];if(domain.resolving){classes.push("fa-spinner");classes.push("fa-spin");classes.unshift("fa");classes.push("fa-sm")}return classes};$scope.get_other_vhost_domains=function(match_domain){return $filter("filter")($scope.domains,function(domain){if(domain.is_wildcard){return false}if(domain.selected){return false}if(domain.resolved===0){return false}if(domain.domain===match_domain.domain){return false}if(domain.virtual_host!==match_domain.virtual_host){return false}return true})};$scope.get_selected_vhosts=function(){var covered_domains=$scope.get_covered_domains();var covered_selected_domains=_.filter(covered_domains,{selected:true});return _.uniq(covered_selected_domains.map(function(domain){return domain.virtual_host}))};function _domain_is_on_partial_vhost(domain){if(domain.selected){return false}if(domain.is_wildcard){return false}if(domain.resolved===0){return false}if($scope.domain_covered_by_wildcard(domain)){return false}if($scope.get_selected_vhosts().indexOf(domain.virtual_host)===-1){return false}return true}$scope.has_partial_vhosts=function(){return $scope.domains.some(_domain_is_on_partial_vhost)};$scope.get_partial_vhost_domains=function(){return $scope.domains.filter(_domain_is_on_partial_vhost)};$scope.get_undercovered_vhost_message=function(other_domains){var flat_domains=other_domains.map(function(domain){return domain.domain});var msg="";msg+="<p>"+LOCALE.maketext("The certificate will secure some, but not all, of the domains on websites on which they exist.")+"</p>";msg+="<p>"+LOCALE.maketext("If you choose to continue, the certificate will not secure the following [numerate,_1,domain,domains], and because a certificate will exist on their website, you may have to purchase a new certificate to secure all of these domains later. [list_and_quoted,_2]",flat_domains.length,flat_domains)+"</p>";return msg};$scope.add_partial_vhost_domains=function(domains){$scope.toggle_values(domains,"selected",true);$scope.update_selected_domains();$scope.check_selected_domains();$scope.goto("domains")};$scope.get_other_domains_msg=function(domain,other_domains){var flat_domains=other_domains.map(function(domain){return domain.domain});var msg="";msg+="<p>"+LOCALE.maketext("This certificate will not secure [quant,_2,other domain,other domains] on the same website as “[_1]”.",domain.domain,flat_domains.length)+"</p>";msg+="<p>"+LOCALE.maketext("Because you cannot secure a single website with multiple certificates, in order to secure any unselected [numerate,_1,domain,domains] in the future, you would need to purchase a new certificate to secure all of these domains.",flat_domains.length)+"</p>";msg+="<p>"+LOCALE.maketext("Would you like to secure the following additional [numerate,_2,domain,domains] with this certificate? [list_and_quoted,_1]",flat_domains,flat_domains.length)+"</p>";return msg};$scope.get_covered_domains=function(){return $filter("filter")($scope.domains,function(domain){if(domain.selected||$scope.domain_covered_by_wildcard(domain)){return true}})};$scope.get_other_wildcard_domains=function(match_domain){if(!match_domain.is_wildcard){return false}return $filter("filter")($scope.domains,function(domain){if(domain.selected){return false}if(domain.is_wildcard){return false}if(domain.domain===match_domain.domain){return false}if(CertificatesService.compare_wildcard_domain(match_domain,domain.domain)===false){return false}return true})};function _is_failed_dcv_domain(domain){return domain.resolved!==1}$scope.has_failed_dcv_domains=function(){return $scope.selected_domains.some(_is_failed_dcv_domain)};$scope.get_failed_dcv_domains=function(){return $scope.selected_domains.filter(_is_failed_dcv_domain)};$scope.get_failed_dcv_message=function(failed_dcv_domains){var flat_domains=failed_dcv_domains.map(function(domain){return domain.domain});var msg="";msg+="<p>"+LOCALE.maketext("The following [numerate,_2,domain,domains] failed [numerate,_2,its,their] [output,abbr,DCV,Domain Control Validation] check: [list_and_quoted,_1]",flat_domains,flat_domains.length)+"</p>";return msg};$scope.clear_failed_domains=function(domains){$scope.toggle_values(domains,"selected",false);$scope.update_selected_domains();if($scope.selected_domains.length===0){$scope.goto("domains")}else if($scope.check_unresolved_issues()===false){$scope.goto("review")}};$scope.domain_covered_by_wildcard=function(domain){if(domain.is_wildcard){return false}var coverage_domain=CertificatesService.domain_covered_by_wildcard(domain.domain);if(coverage_domain&&coverage_domain.selected){return coverage_domain}return false};$scope.get_covered_by_wildcard_message=function(domain){var wildcard=$scope.domain_covered_by_wildcard(domain);if(!wildcard){return""}return LOCALE.maketext("The certificate for wildcard domain “[_1]” will secure this domain.",wildcard.domain)};$scope.is_domain_disabled=function(domain){if($scope.pending_certificate(domain)){return true}if($scope.domain_covered_by_wildcard(domain)){return true}};$scope.get_currency_string=function(num,price_unit){num+=.001;var str=LOCALE.numf(num);str="$"+str.substring(0,str.length-1);if(price_unit){str+=" "+price_unit}return str};$scope.get_products=function(){return CertificatesService.get_products()};$scope._getProductsForDcv=function _getProductsForDcv(){return CertificatesService.filterProductsByDomainsDcv(this.get_products(),this.selected_domains)};$scope.cant_checkout_msg=function(){growl.warning(LOCALE.maketext("You cannot check out until you resolve all errors (in red)."))};$scope.cant_products_msg=function(){growl.warning(LOCALE.maketext("You need to select at least one domain before you can select a product."))};$scope.clear_cloud_domain=function(domain){domain.selected=false;$scope.update_selected_domains();if($scope.selected_domains.length===0&&$scope.panels.review){$scope.goto("domains")}};$scope.goto=function(panel){if(panel==="review"&&$scope.blocker_issues_exist()){$scope.cant_checkout_msg();return}if(panel==="products"&&!$scope.selected_domains.length){$scope.cant_products_msg();panel="domains"}angular.forEach($scope.panels,function(value,key){$scope.panels[key]=false});$scope.panels[panel]=true};$scope.get_product_name=function(product){if(!product){return""}var product_obj=$scope.get_product_by_id(product.provider,product.id);if(!product_obj){return""}return product_obj.display_name};$scope.get_product_by_id=function(provider_name,product_id){return CertificatesService.get_product_by_id(provider_name,product_id)};$scope.check_product_match=function(product_a){var product_b=$scope.get_product();if(!product_a||!product_b){return false}if(product_a.id===product_b.id&&product_a.provider===product_b.provider){return true}};$scope.get_per_price_string=function(product){var prices=[];if(product.price){prices[prices.length]=LOCALE.maketext("[_1] per domain",$scope.get_currency_string(product.price,product.price_unit))}if(product.wildcard_price){prices[prices.length]=LOCALE.maketext("[_1] per wildcard domain",$scope.get_currency_string(product.wildcard_price))}return prices.join(", ")};$scope.get_product_estimate_string=function(product){var price_string=$scope.get_currency_string($scope.calculate_product_price(product));return"("+LOCALE.maketext("[_1] total",price_string,product.price_unit)+")"};var _calculate_product_price=function(product,nonwildcards,wildcards){if(!product){return}var total_price=0;if(wildcards.length&&product.wildcard_price){total_price+=wildcards.length*product.wildcard_price}if(nonwildcards.length&&product.price){total_price+=nonwildcards.length*product.price}if(product.wildcard_parent_domain_included){var nonwildcard_keys={};nonwildcards.forEach(function(domain){nonwildcard_keys[domain.domain]=domain});wildcards.forEach(function(domain){var truly_stripped=domain.domain.replace(/^\*\./,"");if(nonwildcard_keys[truly_stripped]){total_price-=product.price}})}return total_price};$scope.calculate_product_price=function(product){var selected_domains=$scope.selected_domains;var wildcard_domains=$filter("filter")(selected_domains,{is_wildcard:true});var non_wildcard_domains=$filter("filter")(selected_domains,{is_wildcard:false});return _calculate_product_price(product,non_wildcard_domains,wildcard_domains)};$scope.set_product=function(product){$scope.current_certificate.set_product(product)};$scope.get_product=function(){return $scope.current_certificate.get_product()};$scope.get_product_prices=function(){var prices=[];var selected_domains=$scope.selected_domains;var wildcard_domains=selected_domains.filter(function(domain){if(domain.is_wildcard){return true}return false});var non_wildcard_domains=selected_domains.filter(function(domain){if(!domain.is_wildcard){return true}return false});$scope.filteredProductList.forEach(function(product){var price=_calculate_product_price(product,non_wildcard_domains,wildcard_domains);prices.push(price)});return _.sortBy(prices)};$scope.get_min_price=function(){return $scope.get_product_prices().shift()};$scope.get_max_price=function(){return $scope.get_product_prices().pop()};$scope.check_unresolved_issues=function(){if($scope.has_partial_vhosts()){return true}if($scope.has_failed_dcv_domains()){return true}return false};$scope.update_baseless_wildcard_domains=function(){$scope.missing_base_domains=[];$scope.selected_domains.forEach(function(domain){if(domain.is_wildcard===false){return}var main_domain=CertificatesService.get_domain_by_domain(domain.stripped_domain);if(!main_domain.selected){$scope.missing_base_domains.push(main_domain)}});if($scope.missing_base_domains.length){var flat_domains=$scope.missing_base_domains.map(function(domain){return domain.domain});growl.info(LOCALE.maketext("Because wildcard certificates require their parent domains, the system added the following [numerate,_1,domain,domains] for you: [list_and_quoted,_2]",flat_domains.length,flat_domains));$scope.select_baseless_wildcard_domains($scope.missing_base_domains)}};$scope.select_baseless_wildcard_domains=function(missing_domains){$scope.toggle_values(missing_domains,"selected",true);$scope.update_selected_domains()};$scope.get_resolve_panel_color=function(){var color="warning";if($scope.has_partial_vhosts()){color="warning"}if($scope.has_failed_dcv_domains()){color="danger"}return color};$scope.blocker_issues_exist=function(){return $scope.get_resolve_panel_color()==="danger"};$scope.get_cart_price=function(){var price=0;if(!$scope.get_product()){return price}var product=$scope.get_product_by_id($scope.get_product().provider,$scope.get_product().id);var total_price=$scope.calculate_product_price(product);$scope.current_certificate.set_price(total_price);return total_price};$scope.get_cart_strings=function(){return $scope.cart_price_strings};$scope.update_cart_strings=function(){var product=$scope.get_product();var product_prices=$scope.get_product_prices();var selected_domains=$scope.selected_domains;var cart_price={min:0,max:0};if(product&&selected_domains.length){cart_price.min=$scope.get_currency_string($scope.get_cart_price(),"USD")}else if(selected_domains.length){cart_price.min=$scope.get_currency_string($scope.get_min_price(),"USD");if(product_prices.length>1){cart_price.max=$scope.get_currency_string($scope.get_max_price(),"USD")}}else{$scope.cart_price_strings=false}$scope.cart_price_strings=cart_price};$scope.get_cart_items=function(){$scope.cart_items=[$scope.current_certificate];return $scope.cart_items};$scope.purchase=function(){if($scope.blocker_issues_exist()){$scope.cant_checkout_msg();return}$scope.current_certificate.set_identity_verification($scope.identity_verification);CertificatesService.add_new_certificate($scope.current_certificate);var success=CertificatesService.save({simple_identity_verification:$scope.identity_verification});if(!success){growl.error(LOCALE.maketext("Failed to save information to browser cache."))}else{$location.path("/purchase")}};$scope.selectFilterType=function(type){if(type==="all"){$scope.meta.quickFilterValue=""}else{$scope.meta.quickFilterValue=type}$scope.fetch()};$scope.go_to_advanced=function(){CertificatesService.hard_reset();LocationService.go_to_advanced_create_route().search("")};$scope.get_wildcard_base_domain_msg=function(){return LOCALE.maketext("This certificate includes the parent domain in the price of the certificate.")};$scope.fetch=function(){var filteredList=[];filteredList=$scope.filter_domains($scope.domains);angular.forEach(filteredList,function(domain){$scope.get_domain_certificate_type(domain)});if($scope.meta.filterValue!==""){filteredList=filteredList.sort(function(a,b){if(a.domain.length===b.domain.length){return 0}var a_per=$scope.meta.filterValue.length/a.domain.length;var b_per=$scope.meta.filterValue.length/b.domain.length;return a_per<b_per?-1:1})}else{filteredList=filteredList.sort(function(a,b){if(a.domain==="*."+b.domain){return-1}if("*."+a.domain===b.domain){return 1}return b.stripped_domain.localeCompare(a.stripped_domain)})}if($scope.meta.sortDirection!==""&&$scope.meta.sortBy!==""){filteredList=$filter("orderBy")(filteredList,$scope.meta.sortBy,$scope.meta.sortDirection==="asc"?true:false)}$scope.meta.totalItems=filteredList.length;if($scope.meta.totalItems>_.min($scope.meta.pageSizes)){var start=($scope.meta.currentPage-1)*$scope.meta.pageSize;var limit=$scope.meta.pageSize;filteredList=$filter("limitTo")($filter("startFrom")(filteredList,start),limit);$scope.showPager=true;$scope.meta.start=start+1;$scope.meta.limit=start+filteredList.length}else{$scope.showPager=false;if(filteredList.length===0){$scope.meta.start=0}else{$scope.meta.start=1}$scope.meta.limit=filteredList.length}var countNonSelected=0;filteredList.forEach(function(item){if($scope.selected_domains.indexOf(item.id)!==-1){item.rowSelected=true}else{item.rowSelected=false;countNonSelected++}});$scope.filteredList=filteredList;$scope.allRowsSelected=filteredList.length>0&&countNonSelected===0;return filteredList};$scope.fetch_products=function(){var products=this._getProductsForDcv();$scope.filteredProductList=$scope.filter_products(products);return $scope.filteredProductList};$scope.init=function(){if($routeParams["domain"]){var preselect_domains=$routeParams["domain"];if(_.isString(preselect_domains)){preselect_domains=[preselect_domains]}angular.forEach(preselect_domains,function(domain){var dom_obj=CertificatesService.get_domain_by_domain(domain);if(dom_obj){dom_obj.selected=true}})}var product_search_options=CertificatesService.get_product_search_options();var default_search_values={certTerms:{"1_year":true,"2_year":false,"3_year":false}};if($routeParams["certificate_type"]){var preselect_certificate_types=$routeParams["certificate_type"];if(_.isString(preselect_certificate_types)){preselect_certificate_types=[preselect_certificate_types]}var validationType={};if(typeof product_search_options.validationType==="undefined"){validationType["all"]=true}else{angular.forEach(product_search_options.validationType.options,function(option){validationType[option.value]=preselect_certificate_types.indexOf(option.value)!==-1})}default_search_values["validationType"]=validationType}$scope.searchFilterOptions=new SearchSettingsModel(CertificatesService.get_domain_search_options());$scope.productSearchFilterOptions=new SearchSettingsModel(CertificatesService.get_product_search_options(),default_search_values);$scope.fetch();$scope.fetch_products();$scope.current_certificate=new Certificate;$scope.update_selected_domains();if($scope.selected_domains.length){$scope.check_selected_domains();$scope.goto("products")}else{$scope.goto("domains")}};$scope.init()}])});