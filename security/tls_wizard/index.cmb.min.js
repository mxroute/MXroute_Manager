define("app/services/HasIdVerMix",["angular","lodash"],function(){"use strict";var e;try{e=angular.module("App")}catch(t){e=angular.module("App",[])}return e.factory("HasIdVerMix",["$log",function(e){return{set_identity_verification:function(t){if("object"!=typeof t)throw e.error("bad idver",t),new Error;this.identity_verification=t},get_identity_verification:function(){return this.identity_verification}}}])}),define("app/views/Certificate",["angular","lodash","app/services/HasIdVerMix"],function(e,t){"use strict";e.module("App").factory("Certificate",["HasIdVerMix",function(e){function i(e){this.reset(),e&&this.init(e)}return t.assign(i.prototype,e),t.assign(i.prototype,{get_product:function(){return this.selected_product},set_product:function(e){this.selected_product=e},set_price:function(e){this.total_price=e},get_price:function(){return this.total_price},set_domains:function(e){this.domains=e},get_domains:function(){return this.domains},get_subject_names:function(){return this.domains.map(function(e){return{type:"dNSName",name:e.domain,dcv_method:e.dcvPassed.dns?"dns":"http"}})},set_virtual_hosts:function(e){this.virtual_hosts=e},get_virtual_hosts:function(){return this.virtual_hosts},get_validity_period:function(){return this.selected_product.validity_period||[1,"year"]},reset:function(){this.domains=[],this.total_price=null,this.virtual_hosts=[],this.selected_product=null,this.product_price=0,this.product_wildcard_price=0,this.identity_verification=null},toJSON:function(){return{domains:this.domains,total_price:this.total_price,virtual_hosts:this.virtual_hosts,selected_product:this.selected_product,product_price:this.product_price,product_wildcard_price:this.product_wildcard_price,identity_verification:this.get_identity_verification()}},init:function(e){t.assign(this,e)}}),i}])}),define("app/services/VirtualHost",["angular","lodash","app/services/HasIdVerMix"],function(e,t){"use strict";var i;try{i=e.module("App")}catch(r){i=e.module("App",[])}i.factory("VirtualHost",["HasIdVerMix",function(i){function r(t){var i=this;i.display_name="",i.domains=[],i.selected_domains=[],i.filtered_domains={},i.show_wildcards=!0,i.show_domains=!0,i.display_meta={items_per_page:10,current_page:1},i.displayed_domains=[],i.selected_product=null,i.calculated_price=null,i.is_ssl=0,i.product_price=0,i.product_wildcard_price=0,i.added_to_cart=!1,i.current_step="domains",e.extend(i,t)}return e.extend(r.prototype,i),e.extend(r.prototype,{get_display_name:function(){return this.display_name},reset:function(){this.current_step="domains",this.set_product(null),this.set_product_price(0),this.calculated_price=null,this.selected_product=null,e.forEach(this.domains,function(e){e.selected=!1}),this.get_selected_domains()},get_step:function(){return this.current_step},go_step:function(e){return this.current_step=e,this.current_step},get_price:function(){var e=this.get_selected_domains(),t=e.filter(function(e){return e.is_wildcard?!0:void 0});return this.calculated_price=this.product_price*(e.length-t.length)+t.length*this.product_wildcard_price,this.calculated_price},set_product_price:function(e,t){this.product_price=e||0,this.product_wildcard_price=t||0},get_price_string:function(){return"$"+this.get_price().toFixed(2)+" USD"},get_product:function(){return this.selected_product},set_product:function(e){this.selected_product=e},get_domains:function(){return this.domains},set_displayed_domains:function(e){this.displayed_domains=e},get_filtered_domains:function(){var t,i=this.get_domains();if(this.show_wildcards&&this.show_domains)t="all";else if(this.show_wildcards)t="wildcards";else{if(!this.show_domains)return[];t="domains"}if(this.filtered_domains[t])return this.filtered_domains[t];this.filtered_domains[t]=[];var r=this;return e.forEach(i,function(e){return!r.show_wildcards&&e.is_wildcard?!1:r.show_domains||e.is_wildcard?void r.filtered_domains[t].push(e):!1}),this.filtered_domains[t]},get_domain_count:function(e){return e?this.domains.length:this.domains.length/2},get_displayed_domains:function(){this.displayed_domains=[];var e=this.get_filtered_domains();this.display_meta.start=this.display_meta.items_per_page*(this.display_meta.current_page-1),this.display_meta.limit=Math.min(e.length,this.display_meta.start+this.display_meta.items_per_page);for(var t=this.display_meta.start;t<this.display_meta.limit;t++)e[t].is_wildcard||this.displayed_domains.push(e[t]);return this.displayed_domains},add_domain:function(e){if(!this.get_domain_by_domain(e.domain)){e.resolved=-1,e.resolving=!1;var t=this.domains.length;return this.domains.push(e),t}},get_domain_by_domain:function(t){var i;return e.forEach(this.domains,function(e){e.domain===t&&(i=e)}),i},remove_domain:function(e){e.selected=0,this.get_selected_domains()},remove_all_domains:function(){for(var e=0;e<this.domains.length;e++)this.remove_domain(this.domains[e])},is_ready:function(){return 0===this.get_domains().length?!1:this.get_product()?!0:!1},toJSON:function(){var e={};return e.display_name=this.display_name,e.selected_domains=this.selected_domains,e.selected_product=this.selected_product,e.calculated_price=this.calculated_price,e.product_price=this.product_price,e.domains=this.get_domains(),e.identity_verification=this.get_identity_verification(),e},get_selected_domains:function(){var e=t.filter(this.get_domains(),"selected");return this.selected_domains=e,e},has_selected_domains:function(){return t.some(this.get_domains(),"selected")}}),r}])}),define("app/services/CertificatesService",["angular","lodash","cjt/util/locale","cjt/util/html","cjt/util/parse","cjt/io/api","cjt/io/uapi-request","app/views/Certificate","app/services/VirtualHost","cjt/io/uapi","cjt/decorators/growlDecorator"],function(e,t,i,r,n,a,o){"use strict";function s(e){return("0"+e).slice(-2)}function c(e){return e.x_supports_dns_dcv}function d(d,_,u,l,f,p){function m(e,r){var n=i.maketext("The “[_1]” [asis,API] failed due to the following error: [_2]",t.escape(e),r);l.error(n)}function h(e){var t=(new o.Class).initialize("DCV","check_domains_via_dns",{domain:e.map(function(e){return e.domain})});return I(t).then(function(t){for(var a=0;a<e.length;a++){var o=e[a];o.resolving=!1,o.dcvPassed.dns=n.parsePerlBoolean(t.data[a].succeeded),o.dcvPassed.dns?o.resolved=1:(o.resolved=0,o.resolution_failure_reason?o.resolution_failure_reason+=" "+r.decode(i.maketext("[asis,DNS]-based [output,abbr,DCV,Domain Control Validation] also failed.")):o.resolution_failure_reason=r.decode(i.maketext("[asis,DNS]-based [output,abbr,DCV,Domain Control Validation] failed.")))}},function(e){m("DCV::check_domains_via_dns",e)})}function g(){return localStorage.getItem("tls_wizard_data")}function v(e){return[e.getFullYear(),s(1+e.getMonth()),s(e.getDate())].join("-")}var y,w,x={},k=[],b=[],C=[],S=[],E=[],A=[],P=null,D=[],T={},V={},L={},j={},O=new Date,q=!1;x.add_new_certificate=function(e){D.push(e)},x.get_purchasing_certs=function(){return D},x.get_order_by_id=function(e){for(var t=0;t<E.length;t++)if(E[t].order_id===e)return E[t]},x.add_order=function(t){var i=x.get_order_by_id(t.order_id);i?e.extend(i,t):E.push(t)},x.restore=function(){if(x.get_virtual_hosts().length)return!1;var t=g();if(!t)return!1;var i=JSON.parse(t);return e.forEach(i.virtual_hosts,function(e){k.push(new d(e))}),e.forEach(i.purchasing_certs,function(e){x.add_new_certificate(new _(e))}),E=i.orders,k.length===i.virtual_hosts.length&&E.length===i.orders.length},x.add_virtual_host=function(e,t){var i=new d({display_name:e,is_ssl:t}),r=k.length;return k.push(i),r},x.get_virtual_hosts=function(){return k},x.doesDomainMatchOneOf=function(e,t){return null===t||null===e?!1:t.some(function(t){var i=e;if(t===i)return!0;var r,n;if(/^\*/.test(t))r=t,n=i;else{if(!/^\*/.test(i))return!1;r=i,n=t}return r=r.replace(/^\*\./,""),n=n.replace(/^[^\.]+\./,""),r===n?!0:void 0})},x.add_raw_domain=function(t){if(/^www\./.test(t.domain))return void(j[t.domain]=!0);t.virtual_host=t.vhost_name,t.order_by_name=t.domain,t.is_wildcard=0===t.domain.indexOf("*."),t.is_proxy="1"===t.is_proxy.toString(),t.stripped_domain=t.domain,x.add_domain(t);var i=t.domain.match(/^(mail|ipv6)\./);t.is_wildcard||t.is_proxy||i||x.add_domain(e.extend({},t,{domain:"*."+t.domain,is_wildcard:!0}))},x.domain_covered_by_wildcard=function(e){return L[e]},x.compare_wildcard_domain=function(e,t){return L[t]===e.domain},x.build_wildcard_map=function(){L={};var e,i=x.get_all_domains();i.forEach(function(r){return r.is_wildcard===!1?!1:(e=new RegExp("^[^\\.]+\\."+t.escapeRegExp(r.stripped_domain.replace(/^\*\./,""))+"$"),void i.forEach(function(t){r.domain!==t.domain&&e.test(t.domain)&&(L[t.domain]=r)}))})},x.get_domain_certificate_status=function(e){var t=x.get_domain_certificate(e.domain);if(t&&t.certificate){var i=new Date(1e3*t.certificate.not_after),r=(i-O)/1e3/60/60/24;return O>i?"expired":30>r&&r>0?"expiring_soon":"active"}return"unsecured"},x.add_domain=function(t){var i=x.get_virtual_host_by_display_name(t.virtual_host);if(0===i||i||(i=x.add_virtual_host(t.virtual_host,1)),k[i].is_ssl=1,!x.get_domain_by_domain(t.domain)){T[t.domain]=null;var r=V[t.virtual_host];return r&&r.certificate&&e.forEach(r.certificate.domains,function(e){if(t.domain===e)return void(T[t.domain]=r);var i=t.domain.replace(/^[^.]+\./,"*.");i===e&&(T[t.domain]=r)}),t.type=t.is_wildcard?"wildcard_domain":"main_domain",t.proxy_type=t.is_proxy?"proxy_domain":"main_domain",t.certificate_status=x.get_domain_certificate_status(t),k[i].add_domain(t)}},x.remove_virtual_host=function(e){var t=x.get_virtual_host_by_display_name(e);t&&k[t].remove_all_domains()},x.filterProductsByDomainsDcv=function(e,t){var i=t.some(function(e){return e.dcvPassed&&!e.dcvPassed.http});return i&&(e=e.filter(c)),e},x.get_virtual_host_by_display_name=function(e){for(var t=0;t<k.length;t++){if("*"===k[t].display_name)return 0;if(k[t].display_name===e)return t}};var I=function(e){var t=u.defer();return a.promise(e.getRunArguments()).done(function(e){e=e.parsedResponse,e.status?t.resolve(e):t.reject(e.error)}),t.promise};x.set_confirmed_status_for_ssl_certificates=function(t,i){var r=u.defer(),n=new o.Class,s=[];return e.forEach(i.certificates,function(e){s.push(e.order_item_id)}),n.initialize("Market","set_status_of_pending_queue_items"),n.addArgument("provider",t),n.addArgument("status","confirmed"),n.addArgument("order_item_id",s),a.promise(n.getRunArguments()).done(function(e){e=e.parsedResponse;var t=e.status?"resolve":"reject";r[t](e)}),r.promise},x.fetch_domains=function(){var i=x.fetch_installed_hosts();if(t.isFunction(i.then)!==!1)return i.then(function(){return x.fetch_domains()});if(CPANEL.PAGE.domains&&(e.forEach(CPANEL.PAGE.domains,function(e){x.add_raw_domain(e)}),x.get_all_domains().length))return!0;var r=u.defer(),n=new o.Class;return n.initialize("WebVhosts","list_ssl_capable_domains"),a.promise(n.getRunArguments()).done(function(e){e=e.parsedResponse,e.status?r.resolve(e):r.reject(e.error)}),r.promise.then(function(t){e.forEach(t.data,function(e){x.add_raw_domain(e)})},function(e){m("WebVHosts::list_ssl_capable_domains",e)}),r.promise},x.get_store_login_url=function(e,t){var i=u.defer(),r=new o.Class;return r.initialize("Market","get_login_url"),r.addArgument("provider",e),r.addArgument("url_after_login",t),a.promise(r.getRunArguments()).done(function(e){e=e.parsedResponse,e.status?i.resolve(e):i.reject(e.error)}),i.promise},x.store_settings=function(e){var t=x.get_storable_settings(e);localStorage.setItem("tls_wizard_data",t);var i=g();return i===t},x.save=x.store_settings,x.get_stored_extra_settings=function(){var e=g();return e&&(e=JSON.parse(e).extras),e||{}},x.clear_stored_settings=function(){return localStorage.removeItem("tls_wizard_data")},x.get_storable_settings=function(e){var i=g();return i=i?JSON.parse(i):{},i.extras||(i.extras={}),e&&t.assign(i.extras,e),t.assign(i,{orders:E,virtual_hosts:k,purchasing_certs:x.get_purchasing_certs()}),JSON.stringify(i)},x.get_all_domains=function(){return b=[],e.forEach(k,function(e){b=b.concat(e.get_domains())}),b},x.get_all_selected_domains=function(){return C=[],e.forEach(k,function(e){C=C.concat(e.get_selected_domains())}),C},x.get_products=function(){return S},x.fetch_products=function(){if(x.get_products().length)return!0;if(CPANEL.PAGE.products&&(e.forEach(CPANEL.PAGE.products,function(e){x.add_raw_product(e)}),x.get_products().length))return!0;S=[];var t=u.defer(),i=new o.Class;return i.initialize("Market","get_all_products"),i.addFilter("enabled","eq","1"),i.addFilter("product_group","eq","ssl_certificate"),i.addSorting("recommended","dsc","numeric"),i.addSorting("x_price_per_domain","asc","numeric"),a.promise(i.getRunArguments()).done(function(e){e=e.parsedResponse,e.status?t.resolve(e):t.reject(e.error)}),t.promise.then(function(t){e.forEach(t.data,function(e){e.product_id+="",["x_warn_after","x_price_per_domain","x_max_http_redirects"].forEach(function(t){e[t]&&(e[t]=n.parseNumber(e[t]))}),x.add_raw_product(e)})},function(e){m("Market::get_all_products",e)}),t.promise},x._make_certificate_term_label=function(e,t){var r={year:i.maketext("[quant,_1,Year,Years]",t),month:i.maketext("[quant,_1,Month,Months]",t),day:i.maketext("[quant,_1,Day,Days]",t)};return r[e]||t+" "+e},x._make_validation_type_label=function(e){var t={dv:i.maketext("[output,abbr,DV,Domain Validated] Certificate"),ov:i.maketext("[output,abbr,OV,Organization Validated] Certificate"),ev:i.maketext("[output,abbr,EV,Extended Validation] Certificate")};return t[e]||e},x.add_raw_product=function(e){e.id=e.product_id,e.provider=e.provider_name,e.provider_display_name=e.provider_display_name||e.provider,e.price=Number(e.x_price_per_domain),e.wildcard_price=Number(e.x_price_per_wildcard_domain),e.wildcard_parent_domain_included=e.x_wildcard_parent_domain_free&&"1"===e.x_wildcard_parent_domain_free.toString(),e.icon_mime_type=e.icon_mime_type?e.icon_mime_type:"image/png",e.is_wildcard=isNaN(e.wildcard_price)?!1:!0,e.x_certificate_term=e.x_certificate_term||[1,"year"],e.x_certificate_term_display_name=x._make_certificate_term_label(e.x_certificate_term[1],e.x_certificate_term[0]),e.x_certificate_term_key=e.x_certificate_term.join("_"),e.x_validation_type_display_name=x._make_validation_type_label(e.x_validation_type),e.validity_period=e.x_certificate_term,e.x_supports_dns_dcv=n.parsePerlBoolean(e.x_supports_dns_dcv),S.push(e)},x.get_domain_search_options=function(){return w?w:(w={domainType:{label:i.maketext("Domain Types:"),item_key:"type",options:[{value:"main_domain",label:i.maketext("Non-Wildcard"),description:i.maketext("Only list Non-Wildcard domains.")},{value:"wildcard_domain",label:i.maketext("Wildcard"),description:i.maketext("Only list Wildcard domains.")}]},proxyDomainType:{label:i.maketext("Proxy Subdomain Types:"),item_key:"proxy_type",options:[{value:"proxy_domain",label:i.maketext("[asis,cPanel] Proxy Subdomains"),description:i.maketext("Only list proxy subdomains.")},{value:"main_domain",label:i.maketext("Other Domains"),description:i.maketext("Only list non-Proxy domains.")}]},sslType:{label:i.maketext("[asis,SSL] Types:"),item_key:"certificate_type",options:[{value:"unsecured",label:i.maketext("Unsecured or Self-signed"),description:i.maketext("Only list unsecured or self-signed domains.")},{value:"dv",label:x._make_validation_type_label("dv"),description:i.maketext("Only list domains with [asis,DV] Certificates.")},{value:"ov",label:x._make_validation_type_label("ov"),description:i.maketext("Only list domains with [asis,OV] Certificates.")},{value:"ev",label:x._make_validation_type_label("ev"),description:i.maketext("Only list domains with [asis,EV] Certificates.")}]},sslStatus:{label:i.maketext("[asis,SSL] Statuses:"),item_key:"certificate_status",options:[{value:"unsecured",label:i.maketext("Unsecured"),description:i.maketext("Only list unsecured domains.")},{value:"active",label:i.maketext("Active"),description:i.maketext("Only list domains with an active certificate.")},{value:"expired",label:i.maketext("Expired"),description:i.maketext("Only list domains whose certificate is expiring soon.")},{value:"expiring_soon",label:i.maketext("Expiring Soon"),description:i.maketext("Only list domains with certificates that expire soon.")}]}},x.get_domain_search_options())},x.get_product_search_options=function(){if(y)return y;y={validationType:{label:i.maketext("[asis,SSL] Validation Types"),item_key:"x_validation_type",options:[]},sslProvider:{label:i.maketext("[asis,SSL] Providers"),item_key:"provider",options:[]},certTerms:{label:i.maketext("Certificate Terms"),item_key:"x_certificate_term_key",options:[]}};var t=x.get_products(),r={},n={},a={};e.forEach(t,function(e){r[e.x_certificate_term_key]={value:e.x_certificate_term_key,label:e.x_certificate_term_display_name,description:i.maketext("Only list products with a term of ([_1]).",e.x_certificate_term_display_name)},n[e.provider]={value:e.provider,label:e.provider_display_name,description:i.maketext("Only list products from the “[_1]” provider.",e.provider_display_name)},a[e.x_validation_type]={value:e.x_validation_type,label:e.x_validation_type_display_name,description:i.maketext("Only list products that use the “[_1]” validation type.",e.x_validation_type_display_name)}}),e.forEach(r,function(e){y.certTerms.options.push(e)}),e.forEach(n,function(e){y.sslProvider.options.push(e)}),e.forEach(a,function(e){y.validationType.options.push(e)});for(var o in y)y.hasOwnProperty(o)&&y[o].options.length<=1&&delete y[o];return x.get_product_search_options()},x.get_product_by_id=function(e,t){for(var i=0;i<S.length;i++)if(S[i].id===t&&S[i].provider===e)return S[i]};var $=function(r,a){var s=[],d=[];if(e.forEach(r,function(e){-1===e.resolved&&(d.push(e),s.push(e.domain),e.resolving=!0)}),0!==s.length){var _=function(e){return 0===e.x_max_http_redirects},u=(new o.Class).initialize("DCV","check_domains_via_http",{domain:s,dcv_file_allowed_characters:JSON.stringify(a.dcv_file_allowed_characters),dcv_file_random_character_count:a.dcv_file_random_character_count,dcv_file_extension:a.dcv_file_extension,dcv_file_relative_path:a.dcv_file_relative_path,dcv_user_agent_string:a.dcv_user_agent_string}),f=S.filter(c),p=S.filter(_);return I(u).then(function(e){for(var r=[],a=0;a<d.length;a++){var o=d[a];if(o.resolution_failure_reason=e.data[a].failure_reason,o.redirects_count=n.parseNumber(e.data[a].redirects_count),o.redirects_count&&!o.resolution_failure_reason&&p.length){var s=i.maketext("“[_1]”’s [output,abbr,DCV,Domain Control Validation] check completed correctly, but the check required an [asis,HTTP] redirection. The system tried to exclude such redirections from this domain by editing the website document root’s “[_2]” file, but the redirection persists. You should investigate further.",t.escape(o.domain),".htaccess");l.warning(s),f.length||p.length!==S.length||(o.resolution_failure_reason=i.maketext("This domain’s [output,abbr,DCV,Domain Control Validation] check completed correctly, but the check required [asis,HTTP] redirection. Because none of the available certificate products allow [asis,DNS]-based [asis,DCV] or [asis,HTTP] redirection for [asis,DCV], you cannot use this interface to purchase an [asis,SSL] certificate for this domain."))}o.dcvPassed={http:!o.resolution_failure_reason},!f.length||o.dcvPassed.http&&!o.redirects_count?(o.resolving=!1,o.resolved=o.dcvPassed.http?1:0):r.push(o)}return r.length&&f.length?h(r):void 0},function(e){m("DCV::check_domains_via_http",e)})}};x.get_default_provider_name=function(){var e,t=x.get_products(),i=t.filter(function(e){return"cPStore"===e.provider_name?!0:void 0});return e=i.length?i[0]:t[0],e.provider_name},x.get_provider_specific_dcv_constraints=function(e){var t=(new o.Class).initialize("Market","get_provider_specific_dcv_constraints",{provider:e});return I(t)},x.ensure_domains_can_pass_dcv=function(e,t){return x.get_provider_specific_dcv_constraints(t).then(function(t){return $(e,t.data)},function(e){m("Market::get_provider_specific_dcv_constraints",e)})},x.verify_login_token=function(e,t,i){var r=u.defer(),n=new o.Class;return n.initialize("Market","validate_login_token"),n.addArgument("login_token",t),n.addArgument("url_after_login",i),n.addArgument("provider",e),a.promise(n.getRunArguments()).done(function(e){e=e.parsedResponse,e.status?r.resolve(e):r.reject(e.error)}),r.promise},x.set_url_after_checkout=function(e,t,i,r){var n=u.defer(),s=new o.Class;return s.initialize("Market","set_url_after_checkout"),s.addArgument("provider",e),s.addArgument("access_token",t),s.addArgument("order_id",i),s.addArgument("url_after_checkout",r),a.promise(s.getRunArguments()).done(function(e){e=e.parsedResponse;var t=e.status?"resolve":"reject";n[t](e)}),n.promise},x.fetch_valid_www_subject_names=function(e,t){var i=x.fetch_domains(),r=function(){var i=e.filter(function(e){return j["www."+e.domain]}).map(function(e){return{domain:"www."+e.domain,resolved:-1}});return x.ensure_domains_can_pass_dcv(i,t).then(function(){return i})};return i.then?i.then(r):r()};var z=function(e,t,r,n,s){var c={},d=[];s.forEach(function(e){c[e.domain]=1===e.resolved,c[e.domain]||d.push(e.domain)}),d.length&&l.warning(i.maketext("The following “www” [numerate,_1,domain,domains] did not resolve, so the following [numerate,_3,certificate,certificates] will not secure [numerate,_1,it,them]: [list_and_quoted,_2]",d.length,d,r.length));var _=u.defer(),f=new o.Class;f.initialize("Market","request_ssl_certificates"),f.addArgument("provider",e),f.addArgument("access_token",t),f.addArgument("url_after_checkout",n);var m=r.map(function(e){var t={product_id:e.get_product().id,subject_names:e.get_subject_names(),vhost_names:e.get_virtual_hosts(),price:e.get_price(),validity_period:e.get_validity_period()};if(e.get_product().x_identity_verification){var i=e.get_identity_verification();t.identity_verification={},e.get_product().x_identity_verification.forEach(function(e){var r=e.name;if(i[r])if("date"===e.type){var n;try{n=new Date(i[r])}catch(a){p.warn("new Date() failed; ignoring",i[r],a)}n&&(t.identity_verification[r]=v(n))}else t.identity_verification[r]=i[r]})}var r=[];return t.subject_names.forEach(function(e){var t=e.name;c["www."+t]&&r.push({type:"dNSName",name:"www."+t,dcv_method:e.dcv_method})}),t.subject_names=t.subject_names.concat(r),JSON.stringify(t)});return f.addArgument("certificate",m),a.promise(f.getRunArguments()).done(function(e){e=e.parsedResponse,e.status?_.resolve(e):_.reject(e.error)}),_.promise.catch(x.reset.bind(x)),_.promise};x.request_certificates=function(e,t,i,r){var n=[],a=[];return i.forEach(function(e,t){a[t]=[],e.get_domains().forEach(function(e){return e.is_wildcard?!1:(n.push(e),void a[t].push(e))})}),0===n.length?z(e,t,i,r,n):x.fetch_valid_www_subject_names(n,e).then(function(n){return z(e,t,i,r,n)})},x.get_pending_certificates=function(){return A};var N=function(e){A=e,A.forEach(function(e){e.order_id+="",e.order_item_id+="",e.product_id+=""})};x.fetch_pending_certificates=function(){if(CPANEL.PAGE.pending_certificates&&(N(CPANEL.PAGE.pending_certificates),CPANEL.PAGE.pending_certificates=null,A.length))return!0;var e=u.defer(),t=new o.Class;return t.initialize("Market","get_pending_ssl_certificates"),a.promise(t.getRunArguments()).done(function(t){t=t.parsedResponse,t.status?e.resolve(t):e.reject(t.error)}),e.promise.then(function(e){N(e.data)},function(e){m("Market::pending_certificates",e)}),e.promise},x.add_raw_installed_host=function(e){e.certificate.is_self_signed=1===parseInt(e.certificate.is_self_signed,10),P.push(e),V[e.servername]=e},x.get_domain_certificate=function(e){return T[e]},x.get_domain_by_domain=function(e){for(var t=x.get_all_domains(),i=0;i<t.length;i++)if(t[i].domain===e)return t[i]},x.get_virtual_host_certificate=function(e){if(P)for(var t=0;t<P.length;t++)if(P[t].servername===e.display_name)return P[t];return P?P[0]:void 0},x.fetch_installed_hosts=function(){if(P)return!0;if(CPANEL.PAGE.installed_hosts){if(!CPANEL.PAGE.installed_hosts.length)return!0;if(P=[],V={},T={},e.forEach(CPANEL.PAGE.installed_hosts,function(e){x.add_raw_installed_host(e)}),P.length)return!0}var t=u.defer(),i=new o.Class;return i.initialize("SSL","installed_hosts"),a.promise(i.getRunArguments()).done(function(e){e=e.parsedResponse,e.status?t.resolve(e):t.reject(e.error)}),t.promise.then(function(t){P=[],V={},T={},e.forEach(t.data,function(e){x.add_raw_installed_host(e)})},function(e){m("SSL::installed_hosts",e)}),t.promise};var R=function(e){var t=new o.Class;return t.initialize("Batch","strict"),t.addArgument("command",e.map(JSON.stringify,JSON)),t};return x.install_certificate=function(e,t){var i=R(t.map(function(t){return["SSL","install_ssl",{cert:e,domain:t}]}));return I(i)},x.get_ssl_certificate_if_available=function(e,t){var i=new o.Class;return i.initialize("Market","get_ssl_certificate_if_available"),i.addArgument("provider",e),i.addArgument("order_item_id",t),I(i)},x.get_installed_ssl_for_domain=function(e){var t=new o.Class;return t.initialize("SSL","installed_host"),t.addArgument("domain",e),I(t)},x.cancel_pending_ssl_certificate_and_poll=function(e,t){var i=R([["Market","cancel_pending_ssl_certificate",{provider:e,order_item_id:t}],["Market","get_ssl_certificate_if_available",{provider:e,order_item_id:t}]]);return I(i)},x.cancel_pending_ssl_certificates=function(e,t){var i=R(t.map(function(t){return["Market","cancel_pending_ssl_certificate",{provider:e,order_item_id:t}]}));return I(i)},x.cancel_certificate=function(t,i,r){x.cancel_pending_ssl_certificate(i,r).then(function(){e.forEach(t.get_selected_domains(),function(e){e.selected=!1})})},x.process_ssl_pending_queue=function(){var e=u.defer(),t=new o.Class;return t.initialize("Market","process_ssl_pending_queue"),a.promise(t.getRunArguments()).done(function(t){t=t.parsedResponse,t.status?e.resolve(t):e.reject(t.error)}),e.promise},x.hard_reset=function(){x.reset(),CPANEL.PAGE.domains=null},x.reset=function(){k=[],b=[],S=[],P=null,D=[],T={},E=[],L={}},x.reset_purchasing_certificates=function(){D=[]},x.dismiss_introduction=function(){q=!0},x.show_introduction_block=function(){return!q&&!f.getAllMessages().length},x}var _;try{_=e.module("App")}catch(u){_=e.module("App",[])}return _.factory("CertificatesService",["VirtualHost","Certificate","$q","growl","growlMessages","$log",d])}),define("app/services/LocationService",["angular"],function(e){"use strict";return e.module("App").factory("LocationService",["$location",function(e){return{go_to_last_create_route:function(){return e.path(this.last_create_route())},last_create_route:function(){return localStorage.getItem("tls_wizard_create_route")||localStorage.setItem("tls_wizard_create_route","/create"),localStorage.getItem("tls_wizard_create_route")},go_to_simple_create_route:function(){return localStorage.removeItem("tls_wizard_create_route"),this.go_to_last_create_route()},go_to_advanced_create_route:function(){return localStorage.setItem("tls_wizard_create_route","/create-advanced"),this.go_to_last_create_route()}}}])}),define("app/services/IdVerDefaults",["angular","lodash","app/services/CertificatesService"],function(e,t){"use strict";return e.module("App").factory("IdVerDefaults",["CertificatesService",function(e){return{restore_previous:function(i,r){t.assign(i,r),e.get_products().forEach(function(e){e.x_identity_verification&&e.x_identity_verification.forEach(function(e){"date"===e.type&&i[e.name]&&(i[e.name]=new Date(i[e.name]))})})},set_defaults:function(t){var i={};["country_code"].forEach(function(e){i[e]=new Set}),e.get_products().forEach(function(e){e.x_identity_verification&&e.x_identity_verification.forEach(function(e){e.type in i&&i[e.type].add(e.name)})}),i.country_code.forEach(function(e){t[e]=CPANEL.PAGE.guessed_country_code})}}}])}),define("app/services/CountriesService",["angular"],function(e){"use strict";return e.module("App").factory("CountriesService",[function(){return CPANEL.PAGE.countries}])}),define("app/views/VirtualHostsController",["angular","cjt/util/locale","jquery","cjt/modules","ngSanitize","app/services/CertificatesService","app/services/IdVerDefaults","cjt/filters/qaSafeIDFilter","cjt/directives/cpanel/searchSettingsPanel","cjt/directives/triStateCheckbox","cjt/directives/spinnerDirective","cjt/decorators/growlDecorator","app/services/CountriesService","app/services/LocationService"],function(e,t,i){"use strict";function r(r,n,a,o,s,c,d,_,u,l,f,p,m,h,g,v){n.show_introduction_block=l.show_introduction_block,n.domains=l.get_all_domains(),n.virtual_hosts=l.get_virtual_hosts(),n.pending_certificates=l.get_pending_certificates(),n.showExistingCertificates=!1,n.working_virtual_host=null,n.LOCALE=t,n.resolution_timeout=0,n.cart_items=[],n.filterValue=null,n.checkout_mode=!1,n.filteredProducts=[],n.showAdvancedSettings=!0,r.addToCartGrowl=null,n.COUNTRIES=h;var y={};n.identity_verification=y;for(var w=l.get_stored_extra_settings().advanced_identity_verification,x=0;x<n.virtual_hosts.length;x++){var k=n.virtual_hosts[x].get_display_name();y[k]={},w&&w[k]?f.restore_previous(y[k],w[k]):f.set_defaults(y[k])}e.forEach(n.virtual_hosts,function(e){e.reset(),e.show_wildcards=!1}),n.domains=l.get_all_domains(),n.domains=s("filter")(n.domains,{is_wildcard:!1}),n.virtual_hosts=l.get_virtual_hosts(),n.virtual_hosts=s("filter")(n.virtual_hosts,function(e){return!e.display_name.match(/^\*\./)});var b={certTerms:{"1_year":!0,"2_year":!1,"3_year":!1}};n.searchFilterOptions=new v(l.get_product_search_options(),b),n.filter_products=function(){var e=l.get_products();e=n.searchFilterOptions.filter(e),n.filteredProducts=e},n.slow_scroll_to_top=function(){i("body,html").animate({scrollTop:0},2e3)},n.go_to_product_filters=function(){n.showAdvancedSettings=!0,n.slow_scroll_to_top()};var C=["domains","providers","cert-info"],S=s("qaSafeID");n.get_cart_certs_title=function(){return t.maketext("[quant,_1,Certificate,Certificates]",n.get_cart_items().length)},n.get_vhost_showing_text=function(){var e=s("filter")(n.get_virtual_hosts(),n.filterValue);return t.maketext("[output,strong,Showing] [numf,_1] of [quant,_2,website,websites]",e.length,n.get_virtual_hosts().length)},n.get_domains_showing_text=function(e){var i=1+e.display_meta.start,r=e.display_meta.limit,n=e.get_domain_count(!0);return t.maketext("[output,strong,Showing] [numf,_1] - [numf,_2] of [quant,_3,domain,domains].",i,r,n)},n.deselect_unresolved_msg=function(e){var i=e.get_selected_domains().filter(function(e){return 0===e.resolved}).length;return t.maketext("Deselect all unresolved domains ([numf,_1]).",i)},n.go_to_pending=function(e){o.path(e?"/pending-certificates/"+e:"/pending-certificates")},n.pending_certificate=function(t){var i=!1;return e.forEach(n.pending_certificates,function(r){e.forEach(r.vhost_names,function(e){e===t.display_name&&(i=r.order_item_id)})}),i},n.get_certpanel_class=function(e){return n.pending_certificate(e)?"panel-default":"panel-primary"},n.view_pending_certificate=function(e){var t=n.pending_certificate(e);n.go_to_pending(t)},n.get_currency_string=function(e,i){e+=.001;var r=t.numf(e);return r="$"+r.substring(0,r.length-1),i&&(r+=" "+i),r},n.get_virtual_hosts=function(){var e=n.virtual_hosts;return n.filterValue&&(e=s("filter")(e,n.filterValue)),n.checkout_mode&&(e=s("filter")(e,{added_to_cart:!0})),e},n.get_virtual_host_classes=function(e){return{"col-lg-4":n.virtual_hosts.length>2,"col-lg-6":n.virtual_hosts.length<=2,"panel-success":e.is_ssl}},n.get_step_panel_classes=function(e,t){var i=["col-sm-12","col-xs-12"];return n.working_virtual_host===e.display_name?(i.push("col-md-4"),i.push("col-lg-4")):(i.push("col-md-12"),i.push("col-lg-12")),t&&i.push("cert-step-panel-current"),i},n.get_cart_price=function(){var t=0;return e.forEach(n.get_cart_items(),function(e){t+=e.get_price()}),t},n.get_cart_items=function(){return n.cart_items=s("filter")(n.virtual_hosts,{added_to_cart:!0}),n.cart_items},n.checkout=function(){n.checkout_mode=!0},n.get_product_form_fields=function(){return[]},n.get_step=function(e){return e.get_step()},n.go_step=function(e,t){return n.can_step(e,t)?e.go_step(t):void 0
},n.focus_virtual_host=function(){},n.check_selected_domains=function(e){if(n.resolution_timeout&&c.cancel(n.resolution_timeout),e&&e.added_to_cart){var i=s("filter")(e.get_selected_domains(),function(e){return 1!==e.resolved?!0:void 0});i.length&&(m.warning(t.maketext("You have altered an item in your cart. The system has removed that item. After you make the necessary changes, add that item back to your cart.")),n.remove_from_cart(e))}n.resolution_timeout=c(function(e){n.ensure_dns(e)},850,!0,l.get_all_selected_domains())},n.deselect_domains=function(t){e.forEach(t,function(e){e.selected=!1})},n.get_current_or_default_provider=function(){return l.get_default_provider_name()},n.ensure_dns=function(t){if(t=s("filter")(t,{selected:!0,resolved:-1}),!t.length)return!1;e.forEach(t,function(e){e.resolving=!0,p.start(n.get_spinner_id(e.domain))});var i=n.get_current_or_default_provider();return l.ensure_domains_can_pass_dcv(t,i).finally(function(){var i;e.forEach(t,function(e){if(0===e.resolved&&e.selected){var t=l.get_virtual_host_by_display_name(e.vhost_name),r=n.virtual_hosts[t];if(r&&"providers"===r.get_step()){n.go_step(r,"domains");var a=u.document.getElementById(n.get_domain_id(e));a&&!i&&(i=a,c(function(){i.focus()}))}}p.stop(n.get_spinner_id(e.domain))})})},n.get_domain_id=function(e){return S(e.vhost_name+"_"+e.domain)},n.check_product_match=function(e,t){return e&&t?e.id===t.id&&e.provider===t.provider?!0:void 0:!1},n.can_step=function(e,t){if(t===C[0])return!0;if(t===C[1])return e.get_selected_domains().length?!0:!1;if(t===C[2]){var i=e.get_product();if(!i)return!1;if(i=l.get_product_by_id(i.provider,i.id),!i)return!1;if(!n.get_product_form_fields(i))return!1}return!1},n.get_product_by_id=function(e,t){return l.get_product_by_id(e,t)},n.can_next_step=function(t){var i,r=t.get_step();return e.forEach(C,function(e,t){e===r&&(i=C[t+1])}),n.can_step(t,i)},n.next_step=function(t){var i,r=t.get_step();e.forEach(C,function(e,t){e===r&&(i=C[t+1])}),n.can_step(t,i)&&(n.focus_virtual_host(t),t.go_step(i))},n.get_spinner_id=function(e){return S("dns_resolving_"+e)},n.get_products=function(e){return l.filterProductsByDomainsDcv(n.filteredProducts,e.get_selected_domains())},n.set_product=function(e,t){e.set_product_price(t.price),e.set_product(t)},n.all_domains_resolved=function(e){var t=e.get_selected_domains();return t=s("filter")(t,function(e){return 1!==e.resolved?!1:!0}),0===t.length?!1:!0},n.can_add_to_cart=function(e){var t=e.get_product();return t?(t=l.get_product_by_id(t.provider,t.id),t?!0:!1):!1},n.add_to_cart=function(e){if(!n.can_add_to_cart(e)||!n.all_domains_resolved(e))return!1;e.added_to_cart=!0,e.go_step("added-to-cart"),e.set_identity_verification(n.identity_verification[e.display_name]),n.working_virtual_host=null,r.addToCartGrowl&&(r.addToCartGrowl.ttl=0,r.addToCartGrowl=null);var i={ttl:-1,variables:{buttonLabel:t.maketext("Proceed to checkout."),showAction:!0,action:function(){n.purchase()}}};r.addToCartGrowl=m.success(t.maketext("Item Successfully Added to Cart."),i)},n.get_domain_certificate=function(e){return l.get_domain_certificate(e)},n.view_existing_certificate=function(){},n.get_virtual_host_certificate=function(e){return l.get_virtual_host_certificate(e)},n.build_csr_url=function(e){var t=n.get_virtual_host_certificate(e);if(t&&t.certificate){var i="";return i+="../../ssl/install.html?id=",i+=encodeURIComponent(t.certificate.id)}},n.get_existing_certificate_name=function(e){var i,r=n.get_virtual_host_certificate(e);if(r&&r.certificate){var a=r.certificate;"dv"===a.validation_type?i=t.maketext("A [output,abbr,DV,Domain Validated] certificate is installed."):"ov"===a.validation_type?i=t.maketext("An [output,abbr,OV,Organization Validated] certificate is installed."):"ev"===a.validation_type?i=t.maketext("An [output,abbr,EV,Extended Validation] certificate is installed."):a.is_self_signed&&(i=t.maketext("A self-signed certificate is installed."))}return i||(i=t.maketext("A certificate of unknown type is installed.")),i},n.get_domain_lock_classes=function(e){var t=n.get_virtual_host_certificate(e);return t&&t.certificate?t.certificate.is_self_signed?"grey-padlock":"green-padlock":void 0},n.remove_from_cart=function(e){r.addToCartGrowl&&(r.addToCartGrowl.ttl=0,r.addToCartGrowl.destroy(),r.addToCartGrowl=null),e.added_to_cart=!1},n.go_to_simple=function(){l.hard_reset(),g.go_to_simple_create_route().search("")},n.purchase=function(){r.addToCartGrowl&&(r.addToCartGrowl.ttl=0,r.addToCartGrowl.destroy(),r.addToCartGrowl=null);var e=l.save({advanced_identity_verification:y});e?o.path("/purchase"):m.error(t.maketext("Failed to save information to browser cache."))},_.domain&&(e.forEach(s("filter")(n.domains,{domain:_.domain},!0),function(e){e.selected=!0,n.check_selected_domains(e.vhost_name)}),n.virtual_hosts=l.get_virtual_hosts(),n.filterValue=_.domain)}var n=e.module("App");n.controller("VirtualHostsController",["$rootScope","$scope","$controller","$location","$filter","$timeout","$sce","$routeParams","$window","CertificatesService","IdVerDefaults","spinnerAPI","growl","CountriesService","LocationService","SearchSettingsModel",r])}),define("app/views/PurchaseSimpleController",["angular","lodash","cjt/util/locale","app/views/Certificate","app/services/CountriesService","cjt/modules","ngSanitize","app/services/CertificatesService","app/services/LocationService","app/services/IdVerDefaults","cjt/directives/cpanel/searchSettingsPanel","cjt/directives/triStateCheckbox","cjt/filters/qaSafeIDFilter","cjt/directives/spinnerDirective","cjt/directives/quickFiltersDirective","cjt/decorators/growlDecorator"],function(e,t,i){"use strict";var r=e.module("App");r.controller("PurchaseSimpleController",["$rootScope","$scope","$controller","$location","$filter","$timeout","$sce","$routeParams","$window","CertificatesService","IdVerDefaults","growl","CountriesService","Certificate","LocationService","SearchSettingsModel",function(r,n,a,o,s,c,d,_,u,l,f,p,m,h,g,v){function y(e){return e.selected?!1:e.is_wildcard?!1:0===e.resolved?!1:n.domain_covered_by_wildcard(e)?!1:-1===n.get_selected_vhosts().indexOf(e.virtual_host)?!1:!0}function w(e){return 1!==e.resolved}n.show_introduction_block=l.show_introduction_block,n.domains=l.get_all_domains(!0),n.virtual_hosts=l.get_virtual_hosts(),n.pending_certificates=l.get_pending_certificates(),n.showExistingCertificates=!1,n.selected_domains=[],n.working_virtual_host=null,n.LOCALE=i,n.resolution_timeout=0,n.show_wildcard_domains=!0,n.cart_items=[],n.checkout_mode=!1,n.missing_base_domains=[],n.showAdvancedProductSettings=!0,n.panels={},r.addToCartGrowl=null,n.COUNTRIES=m,n.identity_verification={};var x=l.get_stored_extra_settings().simple_identity_verification;x?f.restore_previous(n.identity_verification,x):f.set_defaults(n.identity_verification),e.forEach(n.virtual_hosts,function(e){e.reset(),e.show_wildcards=!0}),l.build_wildcard_map(),n.meta={sortReverse:!1,sortBy:"label",sortDirection:"asc",maxPages:5,totalItems:n.domains.length,currentPage:1,pageSize:20,pageSizes:[20,50,100,250],start:0,limit:20,filterValue:"",productFilterValue:""},n.cart_price_strings=null;var k={certTerms:{"1_year":!0,"2_year":!1,"3_year":!1}};n.searchFilterOptions=new v(l.get_domain_search_options()),n.productSearchFilterOptions=new v(l.get_product_search_options(),k),n.displayProxySubdomains=!0,n.filter_domains=function(e){var t=e;return n.meta.filterValue&&(t=s("filter")(t,n.meta.filterValue)),t=n.searchFilterOptions.filter(t)},n.filter_products=function(e){var t=e,i=n.selected_domains,r=s("filter")(i,{is_wildcard:!0});return t=s("filter")(t,function(e){return!e.wildcard_price&&r.length||!e.price&&i.length-r.length>0?void 0:!0}),n.meta.productFilterValue&&(t=s("filter")(t,n.meta.productFilterValue)),t=n.productSearchFilterOptions.filter(t)},n.toggle_values=function(t,i,r){e.forEach(t,function(e){e[i]=r})},n.get_showing_text=function(){return i.maketext("[output,strong,Showing] [numf,_1] - [numf,_2] of [quant,_3,domain,domains]",n.meta.start,n.meta.limit,n.meta.totalItems)},n.get_resolution_text=function(e){if(e.resolving)return i.maketext("Running Domain Control Validation …");if(0===e.resolved)return i.maketext("Domain Control Validation failed: [_1]",e.resolution_failure_reason);if(1===e.resolved){if(e.dcvPassed.dns){var t;return t=e.redirects_count?i.maketext("[asis,HTTP]-based Domain Control Validation required [quant,_1,redirection,redirections].",e.redirects_count):i.maketext("[asis,HTTP]-based Domain Control Validation failed."),i.maketext("Validated via [asis,DNS]-based Domain Control Validation.")+" ("+t+")"}return i.maketext("Validated via [asis,HTTP]-based Domain Control Validation.")}},n.get_domain_badge_color=function(e){return e.resolving?"info":1===e.resolved?"success":0===e.resolved?"danger":"default"},n.get_cert_status_color=function(e){var t=n.get_domain_certificate(e.domain).certificate;if(t)return"active"!==e.certificate_status||t.is_self_signed?"expired"===e.certificate_status?"label-danger":t.is_self_signed||"expiring_soon"===e.certificate_status?"label-warning":void 0:"label-success"},n.select_domain=function(e){if(e.selected&&e.is_wildcard){var t=s("filter")(n.domains,function(t){return l.compare_wildcard_domain(e,t.domain)});n.toggle_values(t,"selected",!0)}n.update_selected_domains(),n.check_selected_domains()},n.check_selected_domains=function(){n.resolution_timeout&&c.cancel(n.resolution_timeout),n.resolution_timeout=c(function(e){n.ensure_dns(e)},850,!0,l.get_all_selected_domains())},n.update_selected_domains=function(){n.selected_domains=s("filter")(n.domains,function(e){return e.selected?n.domain_covered_by_wildcard(e)?!1:!0:!1}),n.current_certificate.set_domains(n.selected_domains),n.current_certificate.set_virtual_hosts(n.get_selected_vhosts()),n.update_baseless_wildcard_domains(),n.fetch_products(),n.update_cart_strings()},n.get_domain_certificate=function(e){return l.get_domain_certificate(e)},n.get_domain_certificate_type=function(e){if(e.certificate_type)return e.certificate_type;e.certificate_type="unsecured";var t=n.get_domain_certificate(e.domain);return t&&t.certificate&&(t.certificate.is_self_signed||(e.certificate_type=t.certificate.validation_type)),n.get_domain_certificate_type(e)},n.get_domain_cert_msg=function(e){if(e.certificate_status_msg)return e.certificate_status_msg;var t,r=n.get_domain_certificate(e.domain);if(r&&r.certificate){var a=r.certificate;"dv"===a.validation_type?t=i.maketext("A [output,abbr,DV,Domain Validated] certificate already secures this domain."):"ov"===a.validation_type?t=i.maketext("An [output,abbr,OV,Organization Validated] certificate already secures this domain."):"ev"===a.validation_type?t=i.maketext("An [output,abbr,EV,Extended Validation] certificate already secures this domain."):a.is_self_signed&&(t=i.maketext("A self-signed certificate already secures this domain."))}return t||(t=i.maketext("A certificate of unknown type already secures this domain.")),"expired"===e.certificate_status?t+=" "+i.maketext("The certificate has expired."):"expiring_soon"===e.certificate_status&&(t+=" "+i.maketext("It will expire soon.")),e.certificate_status_msg=t,n.get_domain_cert_msg(e)},n.pending_certificate=function(e){var t=n.pendingCertificateObject(e);return t?t.order_item_id:!1},n.pendingCertificateObject=function(t){var i=!1;return e.forEach(n.pending_certificates,function(r){e.forEach(r.vhost_names,function(e){e===t.virtual_host&&(i=r)})}),i},n.view_pending_certificate=function(e){var t=n.pending_certificate(e);n.go_to_pending(t)},n.go_to_pending=function(e){o.path(e?"/pending-certificates/"+e:"/pending-certificates")},n.get_domain_lock_classes=function(e){var t=n.get_domain_certificate(e.domain);return t&&t.certificate?t.certificate.is_self_signed||"expired"===e.certificate_status?"grey-padlock":"green-padlock":void 0},n.build_csr_url=function(e){var t=n.get_virtual_host_certificate(e);if(t&&t.certificate){var i="";return i+="../../ssl/install.html?id=",i+=encodeURIComponent(t.certificate.id)}},n.get_domain_msg_state=function(e){var t=n.pendingCertificateObject(e);if(t){var i=l.doesDomainMatchOneOf(e.domain,t.domains);return i?"cert-pending":"cert-pending-other-domains"}return n.domain_covered_by_wildcard(e)?"covered-by-wildcard":n.get_domain_certificate(e.domain)&&-1===e.resolved&&!e.resolving?"ssl-exists":"default"},n.get_virtual_host_by_display_name=function(e){var t=l.get_virtual_host_by_display_name(e);return n.virtual_hosts[t]},n.get_virtual_host_certificate=function(e){return n.get_domain_certificate(e.domain)},n.ensure_dns=function(e){if(e=s("filter")(e,{selected:!0,resolved:-1}),!e.length)return!1;var t=n.get_current_or_default_provider();return l.ensure_domains_can_pass_dcv(e,t)},n.get_current_or_default_provider=function(){var e=n.get_product();if(e){var t=n.get_product_by_id(e.provider,e.id);if(t)return t.provider_name}return l.get_default_provider_name()},n.get_dcv_class=function(e){var t=[];return e.resolving&&(t.push("fa-spinner"),t.push("fa-spin"),t.unshift("fa"),t.push("fa-sm")),t},n.get_other_vhost_domains=function(e){return s("filter")(n.domains,function(t){return t.is_wildcard?!1:t.selected?!1:0===t.resolved?!1:t.domain===e.domain?!1:t.virtual_host!==e.virtual_host?!1:!0})},n.get_selected_vhosts=function(){var e=n.get_covered_domains(),i=t.filter(e,{selected:!0});return t.uniq(i.map(function(e){return e.virtual_host}))},n.has_partial_vhosts=function(){return n.domains.some(y)},n.get_partial_vhost_domains=function(){return n.domains.filter(y)},n.get_undercovered_vhost_message=function(e){var t=e.map(function(e){return e.domain}),r="";return r+="<p>"+i.maketext("The certificate will secure some, but not all, of the domains on websites on which they exist.")+"</p>",r+="<p>"+i.maketext("If you choose to continue, the certificate will not secure the following [numerate,_1,domain,domains], and because a certificate will exist on their website, you may have to purchase a new certificate to secure all of these domains later. [list_and_quoted,_2]",t.length,t)+"</p>"},n.add_partial_vhost_domains=function(e){n.toggle_values(e,"selected",!0),n.update_selected_domains(),n.check_selected_domains(),n.goto("domains")},n.get_other_domains_msg=function(e,t){var r=t.map(function(e){return e.domain}),n="";return n+="<p>"+i.maketext("This certificate will not secure [quant,_2,other domain,other domains] on the same website as “[_1]”.",e.domain,r.length)+"</p>",n+="<p>"+i.maketext("Because you cannot secure a single website with multiple certificates, in order to secure any unselected [numerate,_1,domain,domains] in the future, you would need to purchase a new certificate to secure all of these domains.",r.length)+"</p>",n+="<p>"+i.maketext("Would you like to secure the following additional [numerate,_2,domain,domains] with this certificate? [list_and_quoted,_1]",r,r.length)+"</p>"},n.get_covered_domains=function(){return s("filter")(n.domains,function(e){return e.selected||n.domain_covered_by_wildcard(e)?!0:void 0})},n.get_other_wildcard_domains=function(e){return e.is_wildcard?s("filter")(n.domains,function(t){return t.selected?!1:t.is_wildcard?!1:t.domain===e.domain?!1:l.compare_wildcard_domain(e,t.domain)===!1?!1:!0}):!1},n.has_failed_dcv_domains=function(){return n.selected_domains.some(w)},n.get_failed_dcv_domains=function(){return n.selected_domains.filter(w)},n.get_failed_dcv_message=function(e){var t=e.map(function(e){return e.domain}),r="";return r+="<p>"+i.maketext("The following [numerate,_2,domain,domains] failed [numerate,_2,its,their] [output,abbr,DCV,Domain Control Validation] check: [list_and_quoted,_1]",t,t.length)+"</p>"},n.clear_failed_domains=function(e){n.toggle_values(e,"selected",!1),n.update_selected_domains(),0===n.selected_domains.length?n.goto("domains"):n.check_unresolved_issues()===!1&&n.goto("review")},n.domain_covered_by_wildcard=function(e){if(e.is_wildcard)return!1;var t=l.domain_covered_by_wildcard(e.domain);return t&&t.selected?t:!1},n.get_covered_by_wildcard_message=function(e){var t=n.domain_covered_by_wildcard(e);return t?i.maketext("The certificate for wildcard domain “[_1]” will secure this domain.",t.domain):""},n.is_domain_disabled=function(e){return n.pending_certificate(e)?!0:n.domain_covered_by_wildcard(e)?!0:void 0},n.get_currency_string=function(e,t){e+=.001;var r=i.numf(e);return r="$"+r.substring(0,r.length-1),t&&(r+=" "+t),r},n.get_products=function(){return l.get_products()},n._getProductsForDcv=function(){return l.filterProductsByDomainsDcv(this.get_products(),this.selected_domains)},n.cant_checkout_msg=function(){p.warning(i.maketext("You cannot check out until you resolve all errors (in red)."))},n.cant_products_msg=function(){p.warning(i.maketext("You need to select at least one domain before you can select a product."))},n.clear_cloud_domain=function(e){e.selected=!1,n.update_selected_domains(),0===n.selected_domains.length&&n.panels.review&&n.goto("domains")},n.goto=function(t){return"review"===t&&n.blocker_issues_exist()?void n.cant_checkout_msg():("products"!==t||n.selected_domains.length||(n.cant_products_msg(),t="domains"),e.forEach(n.panels,function(e,t){n.panels[t]=!1}),void(n.panels[t]=!0))},n.get_product_name=function(e){if(!e)return"";var t=n.get_product_by_id(e.provider,e.id);return t?t.display_name:""},n.get_product_by_id=function(e,t){return l.get_product_by_id(e,t)},n.check_product_match=function(e){var t=n.get_product();return e&&t?e.id===t.id&&e.provider===t.provider?!0:void 0:!1},n.get_per_price_string=function(e){var t=[];return e.price&&(t[t.length]=i.maketext("[_1] per domain",n.get_currency_string(e.price,e.price_unit))),e.wildcard_price&&(t[t.length]=i.maketext("[_1] per wildcard domain",n.get_currency_string(e.wildcard_price))),t.join(", ")},n.get_product_estimate_string=function(e){var t=n.get_currency_string(n.calculate_product_price(e));return"("+i.maketext("[_1] total",t,e.price_unit)+")"};var b=function(e,t,i){if(e){var r=0;if(i.length&&e.wildcard_price&&(r+=i.length*e.wildcard_price),t.length&&e.price&&(r+=t.length*e.price),e.wildcard_parent_domain_included){var n={};t.forEach(function(e){n[e.domain]=e}),i.forEach(function(t){var i=t.domain.replace(/^\*\./,"");n[i]&&(r-=e.price)})}return r}};n.calculate_product_price=function(e){var t=n.selected_domains,i=s("filter")(t,{is_wildcard:!0}),r=s("filter")(t,{is_wildcard:!1});return b(e,r,i)},n.set_product=function(e){n.current_certificate.set_product(e)},n.get_product=function(){return n.current_certificate.get_product()},n.get_product_prices=function(){var e=[],i=n.selected_domains,r=i.filter(function(e){return e.is_wildcard?!0:!1}),a=i.filter(function(e){return e.is_wildcard?!1:!0});return n.filteredProductList.forEach(function(t){var i=b(t,a,r);e.push(i)}),t.sortBy(e)},n.get_min_price=function(){return n.get_product_prices().shift()},n.get_max_price=function(){return n.get_product_prices().pop()},n.check_unresolved_issues=function(){return n.has_partial_vhosts()?!0:n.has_failed_dcv_domains()?!0:!1},n.update_baseless_wildcard_domains=function(){if(n.missing_base_domains=[],n.selected_domains.forEach(function(e){if(e.is_wildcard!==!1){var t=l.get_domain_by_domain(e.stripped_domain);t.selected||n.missing_base_domains.push(t)}}),n.missing_base_domains.length){var e=n.missing_base_domains.map(function(e){return e.domain});p.info(i.maketext("Because wildcard certificates require their parent domains, the system added the following [numerate,_1,domain,domains] for you: [list_and_quoted,_2]",e.length,e)),n.select_baseless_wildcard_domains(n.missing_base_domains)}},n.select_baseless_wildcard_domains=function(e){n.toggle_values(e,"selected",!0),n.update_selected_domains()},n.get_resolve_panel_color=function(){var e="warning";return n.has_partial_vhosts()&&(e="warning"),n.has_failed_dcv_domains()&&(e="danger"),e},n.blocker_issues_exist=function(){return"danger"===n.get_resolve_panel_color()},n.get_cart_price=function(){var e=0;if(!n.get_product())return e;var t=n.get_product_by_id(n.get_product().provider,n.get_product().id),i=n.calculate_product_price(t);return n.current_certificate.set_price(i),i},n.get_cart_strings=function(){return n.cart_price_strings},n.update_cart_strings=function(){var e=n.get_product(),t=n.get_product_prices(),i=n.selected_domains,r={min:0,max:0};e&&i.length?r.min=n.get_currency_string(n.get_cart_price(),"USD"):i.length?(r.min=n.get_currency_string(n.get_min_price(),"USD"),t.length>1&&(r.max=n.get_currency_string(n.get_max_price(),"USD"))):n.cart_price_strings=!1,n.cart_price_strings=r},n.get_cart_items=function(){return n.cart_items=[n.current_certificate],n.cart_items},n.purchase=function(){if(n.blocker_issues_exist())return void n.cant_checkout_msg();n.current_certificate.set_identity_verification(n.identity_verification),l.add_new_certificate(n.current_certificate);var e=l.save({simple_identity_verification:n.identity_verification});e?o.path("/purchase"):p.error(i.maketext("Failed to save information to browser cache."))},n.selectFilterType=function(e){n.meta.quickFilterValue="all"===e?"":e,n.fetch()},n.go_to_advanced=function(){l.hard_reset(),g.go_to_advanced_create_route().search("")},n.get_wildcard_base_domain_msg=function(){return i.maketext("This certificate includes the parent domain in the price of the certificate.")},n.fetch=function(){var i=[];if(i=n.filter_domains(n.domains),e.forEach(i,function(e){n.get_domain_certificate_type(e)}),i=i.sort(""!==n.meta.filterValue?function(e,t){if(e.domain.length===t.domain.length)return 0;var i=n.meta.filterValue.length/e.domain.length,r=n.meta.filterValue.length/t.domain.length;return r>i?-1:1}:function(e,t){return e.domain==="*."+t.domain?-1:"*."+e.domain===t.domain?1:t.stripped_domain.localeCompare(e.stripped_domain)}),""!==n.meta.sortDirection&&""!==n.meta.sortBy&&(i=s("orderBy")(i,n.meta.sortBy,"asc"===n.meta.sortDirection?!0:!1)),n.meta.totalItems=i.length,n.meta.totalItems>t.min(n.meta.pageSizes)){var r=(n.meta.currentPage-1)*n.meta.pageSize,a=n.meta.pageSize;i=s("limitTo")(s("startFrom")(i,r),a),n.showPager=!0,n.meta.start=r+1,n.meta.limit=r+i.length}else n.showPager=!1,n.meta.start=0===i.length?0:1,n.meta.limit=i.length;var o=0;return i.forEach(function(e){-1!==n.selected_domains.indexOf(e.id)?e.rowSelected=!0:(e.rowSelected=!1,o++)}),n.filteredList=i,n.allRowsSelected=i.length>0&&0===o,i},n.fetch_products=function(){var e=this._getProductsForDcv();return n.filteredProductList=n.filter_products(e),n.filteredProductList},n.init=function(){if(_.domain){var i=_.domain;t.isString(i)&&(i=[i]),e.forEach(i,function(e){var t=l.get_domain_by_domain(e);t&&(t.selected=!0)})}var r=l.get_product_search_options(),a={certTerms:{"1_year":!0,"2_year":!1,"3_year":!1}};if(_.certificate_type){var o=_.certificate_type;t.isString(o)&&(o=[o]);var s={};"undefined"==typeof r.validationType?s.all=!0:e.forEach(r.validationType.options,function(e){s[e.value]=-1!==o.indexOf(e.value)}),a.validationType=s}n.searchFilterOptions=new v(l.get_domain_search_options()),n.productSearchFilterOptions=new v(l.get_product_search_options(),a),n.fetch(),n.fetch_products(),n.current_certificate=new h,n.update_selected_domains(),n.selected_domains.length?(n.check_selected_domains(),n.goto("products")):n.goto("domains")},n.init()}])}),define("app/views/CheckoutController",["lodash","angular","jquery","cjt/util/locale","cjt/util/query","app/views/Certificate","cjt/modules","app/services/CertificatesService","app/services/LocationService","cjt/directives/spinnerDirective","cjt/decorators/growlDecorator","uiBootstrap"],function(e,t,i,r,n){"use strict";function a(a,o,s,c,d,_,u,l,f,p,m,h,g,v,y){function w(e){return e.replace(/^\s*-\S+/,"").replace(/-\S+\s*$/,"").replace(/\s+/g,"")}function x(e){if(!(e instanceof Array))throw"Only arrays here!";return m.all(e.map(function(e,t){return m(function(i,r){e.then(i,function(e){r([t,e])})})}))}function k(){i(".checkout-step-inner").each(function(e,t){t=i(t);var r=t.find(".content-wrapper"),n=(t.height()-r.height())/2;r.css("padding-top",n)})}var b={cPStore:["login","send_cart_items","checkout","payment_callback","checkout_complete"],"default":["login","send_cart_items","checkout","payment_callback","checkout_complete"]};a.pending_certificates=l.get_pending_certificates(),a.LOCALE=r,a.purchase_steps=[],a.current_step=-1,a.start_step=null,a.providers=[],a.certificates_count=0,a.steps=[],a.html_escape=e.escape.bind(e),a.get_step_classes=function(e,t){var i=a.get_steps(e.name).length,r=a.get_step_index(e.name,t),n=Math.floor(12/i),o=["col-xs-12","col-sm-12","col-md-"+n,"col-lg-"+n,"checkout-step"];return a.current_step_index===r?(o.push("checkout-step-current"),"checkout_complete"===t&&o.push("checkout-step-completed")):a.current_step_index>r&&o.push("checkout-step-completed"),o},a.cert_count_title=function(){return r.maketext("Purchasing [quant,_1,certificate,certificates] …",a.certificates_count)},a.get_purchases_title=function(e){return r.maketext("Completing [numerate,_2,purchase,purchases] for the “[_1]” provider …",a.html_escape(e.display_name),e.certificates.length)},a.sending_items_msg=function(){return r.maketext("Sending your [numerate,_1,item,items] to the store cart …",a.certificates_count)},a.starting_polling_msg=function(){return r.maketext("Starting background polling for the [numerate,_1,certificate,certificates]. The system will download and install the [numerate,_1,certificate,certificates] when available.",a.certificates_count)},a.get_provider_by_name=function(e){for(var t=0;t<a.providers.length;t++)if(a.providers[t].name===e)return a.providers[t]},a.get_steps=function(e){return b[e]?b[e]:b["default"]},a.get_current_step=function(){return a.steps[a.current_step_index]},a.get_step_index=function(e,t){for(var i=0;i<a.steps.length;i++)if(a.steps[i].provider===e&&a.steps[i].step===t)return i;return 0},a.get_step_url=function(e){return"/"+encodeURIComponent(e.provider)+"/"+encodeURIComponent(e.step)},a.get_next_step=function(){return a.current_step_index+1<a.steps.length?a.steps[a.current_step_index+1]:void 0},a.get_param=function(e){return n.parse_query_string(location.search.replace(/^\?/,""))[e]||d[e]},a.require_params=function(e){var i=[],n=[];return t.forEach(e,function(e){var t=a.get_param(e);t?t instanceof Array&&n.push(e):i.push(e)}),i.length&&p.error(r.maketext("The following [numerate,_1,parameter is,parameters are] required but [numerate,_1,does,do] not appear in the [asis,URL]: [list_and_quoted,_2]",i.length,i)),n.length&&p.error(r.maketext("The following [numerate,_1,parameter appears,parameters appear] more than once in the [asis,URL]: [list_and_quoted,_2]",n.length,n)),i.length||n.length?!1:!0},a.in_debug_mode=!1,a.get_route_url=function(){var e="";return e+=s.absUrl().replace(/tls_wizard\/.+/,"tls_wizard/#/purchase")},a.dismiss_modal=function(){this.modal.dismiss()},a.go_to_purchase_page=y.go_to_last_create_route,a.go_to_login=function(){this.go_step(this.get_current_step().provider,"login")},a.do_current_step=function(){var i=a.get_current_step();if(!i)return void y.go_to_last_create_route();var n,o=a.get_next_step(),c=a.get_param("order_id"),d=a.get_param("code"),f=l.get_order_by_id(c),m=a.get_param("order_status"),g=a.get_provider_by_name(i.provider),v=a.get_param("access_token");if("login"===i.step)n=a.get_route_url()+a.get_step_url(i),f&&(n+="?order_id="+f.order_id),d?l.verify_login_token(i.provider,d,n).then(function(e){f?a.go_step(i.provider,"checkout",{order_id:f.order_id,access_token:e.data.access_token}):a.go_step(i.provider,"send_cart_items",{access_token:e.data.access_token})},function(e){a.return_to_wizard(),p.error(r.maketext("The system encountered an error as it attempted to verify the login token: [_1]",e)+" "+r.maketext("You will now return to the beginning of the wizard."))}):l.get_store_login_url(i.provider,n).then(function(e){_.location.href=e.data},function(e){a.return_to_wizard(),p.error(r.maketext("The system encountered an error as it attempted to get the store login [output,abbr,URL,Uniform Resource Location]: [_1]",e)+" "+r.maketext("You will now return to the beginning of the wizard."))});else{if("send_cart_items"===i.step){if(!a.require_params(["access_token"]))return;return n=a.get_route_url()+a.get_step_url(o),l.request_certificates(i.provider,v,g.certificates).then(function(e){var t=e.data;t.order_id=t.order_id.toString(),l.add_order(t),l.save(),a.go_step(i.provider,"checkout",{order_id:t.order_id,access_token:v})},function(e){a.return_to_wizard(),p.error(r.maketext("The system encountered an error as it attempted to request the [asis,SSL] [numerate,_2,certificate,certificates]: [_1]",e,a.get_provider_by_name(i.provider).certificates.length)+" "+r.maketext("You will now return to the beginning of the wizard."))})}if("checkout"===i.step){if(!a.require_params(["order_id"]))return;if(n=a.get_route_url()+a.get_step_url(i),m)a.go_step(i.provider,"payment_callback",{order_id:f.order_id,order_status:m});else{if(!a.require_params(["access_token"]))return;l.set_url_after_checkout(i.provider,v,f.order_id,n).then(function(){_.location.href=f.checkout_url},function(t){var n=t.data&&"OrderNotFound"===t.data.error_type;n?(a.order_id=f.order_id,a.provider=a.get_provider_by_name(i.provider),a.modal=h.open({template:document.getElementById("user-mismatch-modal").text,scope:a,backdrop:"static",animation:!1,size:"sm"})):(y.go_to_last_create_route(),p.error(r.maketext("The system encountered an error as it attempted to set the [asis,URL] after checkout: [_1]",e.escape(t.error))+" "+r.maketext("You will now return to the beginning of the wizard.")))})}}else if("payment_callback"===i.step){if(CPANEL.PAGE.pending_certificates=null,CPANEL.PAGE.installed_hosts=null,"success"!==m){if("error"===m)l.reset(),l.save(),a.return_to_wizard(),p.error(r.maketext("The system encountered an error as it attempted to complete your transaction.")+" "+r.maketext("You will now return to the beginning of the wizard."));else if(/^cancel?led$/.test(m)){var k=[];t.forEach(f.certificates,function(e){k.push(e.order_item_id)}),p.warning(r.maketext("You seem to have canceled your transaction.")+" "+r.maketext("You will now return to the beginning of the wizard.")),s.url(s.path()),l.cancel_pending_ssl_certificates(i.provider,k).then(function(){l.reset(),l.save(),a.return_to_wizard()},function(e){p.error(r.maketext("The system encountered an error as it attempted to cancel your transaction: [_1]",e)+" "+r.maketext("You will now return to the beginning of the wizard."))})}return!1}p.success(r.maketext("You have successfully completed your certificate order (order ID “[_1]”). If you need help with this order, use the support [numerate,_2,link,links] below.",e.escape(c),f.certificates.length)),l.set_confirmed_status_for_ssl_certificates(i.provider,f).then(function(){a.go_step(i.provider,o.step)},function(t){if(t.data&&"EntryDoesNotExist"===t.data.error_type){var n=t.data.order_item_ids,o=r.maketext("There are no pending certificates from “[_1]” with the following order item [numerate,_2,ID,IDs]: [join,~, ,_3]. The system will now verify that the [numerate,_2,certificate has,certificates have] been issued and installed.",e.escape(i.provider),n.length,n.map(e.escape.bind(e)));p.info(o);var s=g.certificates;n.forEach(function(t){var n=l.get_ssl_certificate_if_available(i.provider,t);s.forEach(function(a){a.get_virtual_hosts().forEach(function(o){var s=a.get_domains().filter(function(e){return e.virtual_host===o}).pop().domain,d=x([l.get_installed_ssl_for_domain(),n]);d.then(function(n){var a,d=n[0].data.certificate.text;d&&(a=w(d));var _,u=n[1].data.certificate_pem;if(!u){var f=n[1].data.status_code;return p.error(/OrderCancell?ed/.test(f)?r.maketext("“[_1]” indicated that the order with [asis,ID] “[_2]” has been canceled.",e.escape(i.provider),e.escape(c)):/OrderItemCancell?ed/.test(f)?r.maketext("“[_1]” indicated that the certificate with order item [asis,ID] “[_2]” has been canceled.",e.escape(i.provider),e.escape(t)):r.maketext("“[_1]” has not issued a certificate for order item [asis,ID] “[_2]”. Contact them for further assistance.",e.escape(i.provider),e.escape(t))),void y.go_to_last_create_route()
}if(_=w(u),_===a)p.success(r.maketext("The system confirmed that the certificate for the website “[_1]” is installed.",e.escape(o))),y.go_to_last_create_route();else{if(a)p.info(r.maketext("“[_1]” has an [asis,SSL] certificate installed, but it is not the certificate that you just ordered (order item [asis,ID] “[_2]”). The system will now install this certificate.",e.escape(o),e.escape(t)));else{var m;m=r.maketext("You do not have an [asis,SSL] certificate installed for the website “[_1]”.",e.escape(o)),m+=r.maketext("The system will now install the new certificate."),p.info(m)}l.install_certificate(u,[s]).then(function(){p.success(r.maketext("The system installed the certificate onto the website “[_1]”.",e.escape(o)))},function(t){p.error(r.maketext("The system failed to install the certificate onto the website “[_1]” because of the following error: [_2]",e.escape(o),t))}).then(y.go_to_last_create_route)}},function(n){var a=n[0],s=n[1];p.error(0===a?r.maketext("The system failed to locate the installed [asis,SSL] certificate for the website “[_1]” because of the following error: [_2]",e.escape(o),s):1===a?r.maketext("The system failed to query “[_1]” for order item [asis,ID] “[_2]” ([_3]) because of the following error: [_4]",e.escape(i.provider),e.escape(t),e.escape(o),s):"Unknown index: "+a),y.go_to_last_create_route()})})})})}else{var d=t.error;p.error(r.maketext("The system failed to begin polling for [quant,_2,new certificate,new certificates] because of an error: [_1]",d,a.certificates_count)+" "+r.maketext("You will now return to the beginning of the wizard."))}})}else"checkout_complete"===i.step&&(o||(l.reset(),l.save(),p.success(r.maketext("The system has completed the [numerate,_1,purchase,purchases] and will begin to poll for your [numerate,_2,certificate,certificates].",a.providers.length,a.certificates_count)),u(a.go_to_pending,1e3)))}},a.return_to_wizard=function(){var e=s.absUrl();if(a.get_param("code")){var t=e.replace(/([^#?]+\/).*/,"$1#"+y.last_create_route());_.location.href=t}else y.go_to_last_create_route()},a.check_step_success=function(e){return e<a.current_step_index?!0:void 0},a.go_step=function(e,t,i){s.path("/purchase/"+e+"/"+t+"/"),i&&s.search(i)},a.get_providers=function(){a.providers=[];var e;return a.purchasing_certs.forEach(function(i){var r=i.get_product(),n=a.get_provider_by_name(r.provider);n||(n={name:r.provider,display_name:r.provider_display_name||r.provider,certificates:[]},a.providers.push(n),e=a.get_steps(n.name),t.forEach(e,function(e){a.steps.push({provider:n.name,step:e})})),n.certificates.push(i),a.certificates_count++}),a.providers},a.go_to_pending=function(e){s.path(e?"/pending-certificates/"+e:"/pending-certificates")},a.pending_certificate=function(e){var i=!1;return t.forEach(a.pending_certificates,function(r){t.forEach(r.vhost_names,function(t){t===e.display_name&&(i=r.order_item_id)})}),i},a.view_pending_certificate=function(e){var t=a.pending_certificate(e);a.go_to_pending(t)},a.begin=function(){a.purchasing_certs=l.get_purchasing_certs(),0===a.purchasing_certs.length&&(l.get_virtual_hosts().filter(function(e){if(!e.has_selected_domains())return!1;var t=e.get_product();return t?l.get_product_by_id(t.provider,t.id)?!0:void g.warn("Unknown product!",t):void g.warn("has selected, but no product?")}).forEach(function(e){var t=e.get_product(),i=new v;if(i.set_product(t),i.set_price(e.get_price()),i.set_domains(e.get_selected_domains()),i.set_virtual_hosts([e.display_name]),t.x_identity_verification){var r=e.get_identity_verification();r&&i.set_identity_verification(r)}l.add_new_certificate(i)}),a.purchasing_certs=l.get_purchasing_certs()),a.get_providers(),a.current_provider_name=d.provider,a.current_step_id=d.step,a.current_step_index=a.get_step_index(a.current_provider_name,a.current_step_id),a.do_current_step(),u(function(){k()},1)},a.init=function(){l.restore(),a.begin()};var C=t.element(_);C.bind("resize",k),a.init()}var o=t.module("App");o.controller("CheckoutController",["$scope","$controller","$location","$filter","$routeParams","$window","$timeout","CertificatesService","spinnerAPI","growl","$q","$uibModal","$log","Certificate","LocationService",a])}),define("app/views/PendingCertificatesController",["lodash","angular","cjt/util/locale","app/views/Certificate","cjt/modules","cjt/directives/spinnerDirective","app/services/CertificatesService","app/services/LocationService","cjt/directives/actionButtonDirective","cjt/decorators/growlDecorator"],function(e,t,i){"use strict";function r(r,n,a,o,s,c,d,_,u,l){function f(e,t){var n;if("RequiresApproval"===e){var a=r.get_provider_display_name(t);n=i.maketext("Waiting for “[_1]” to approve your order …",a)}return n}var p={};CPANEL.PAGE.products.forEach(function(e){p[e.provider]=e.provider_display_name}),r.show_introduction_block=d.show_introduction_block,r.get_provider_display_name=function(e){return p[e]||e},r.html_escape=e.escape,r.get_time=function(){return parseInt(Date.now()/1e3,10)},r.LOCALE=i,r.checking_pending_queue=!1,r.cjt1_LOCALE=window.LOCALE,r.pending_certificates=d.get_pending_certificates(),r.expanded_cert=null,r.get_product_by_id=function(e,t){return d.get_product_by_id(e,t)},r.get_cert_title=function(e){var t=e.domains.sort(function(e,t){return e.length===t.length?0:e.length>t.length?1:-1});return 1===t.length?t[0]:i.maketext("“[_1]” and [quant,_2,other domain,other domains]",t[0],t.length-1)},r.check_pending_queue=function(){return d.process_ssl_pending_queue().then(function(n){var a=[],o=0;if(n.data.forEach(function(t){if(t.installed)a.push(t);else switch(t.last_status_code){case"OrderCanceled":case"OrderItemCanceled":o++;var n=r.get_provider_display_name(t.provider),s=t.domains;_.info(1===s.length?i.maketext("“[_1]” reports that the certificate for “[_2]” has been canceled.",e.escape(n),e.escape(s[0])):i.maketext("“[_1]” reports that the certificate for “[_2]” and [quant,_3,other domain,other domains] has been canceled.",e.escape(n),e.escape(s[0]),s.length-1))}}),a.length){var s=[];t.forEach(a,function(e){s=s.concat(e.vhost_names)}),_.success(i.maketext("[numerate,_2,A certificate,Certificates] for the following [numerate,_2,website was,websites were] available, and the system has installed [numerate,_2,it,them]: [list_and_quoted,_1]",s,a.length))}else o||_.info(i.maketext("The system processed the pending certificate queue successfully, but [numerate,_1,your pending certificate was not,none of your pending certificates were] available.",n.data.length));return d.fetch_pending_certificates().then(function(){r.pending_certificates=d.get_pending_certificates(),0===r.pending_certificates.length?(_.info(i.maketext("You have no more pending [asis,SSL] certificates.")+" "+i.maketext("You will now return to the beginning of the wizard.")),d.reset(),CPANEL.PAGE.installed_hosts=null,CPANEL.PAGE.domains=null,r.get_new_certs()):r.prepare_pending_certificates()})},_.error.bind(_))},r.reset_and_create=function(){d.hard_reset(),r.get_new_certs()},r.get_new_certs=function(){u.go_to_last_create_route().search("")},r.cancel_purchase=function(t){d.cancel_pending_ssl_certificate_and_poll(t.provider,t.order_item_id).then(function(n){var a=n.data[1].data,o=a.certificate_pem,s=e.escape(r.get_provider_display_name(t.provider));return o?(_.info(i.maketext("You have canceled this order, but “[_1]” already issued the certificate. The system will now install it. ([output,url,_2,Do you need help with this order?])",s,t.support_uri)),d.install_certificate(o,t.vhost_names).then(function(){_.success(i.maketext("The system has installed the new [asis,SSL] certificate on to the [numerate,_1,website,websites] [list_and_quoted,_2].",t.vhost_names.length,t.vhost_names))},function(e){_.error(i.maketext("The system failed to install the new [asis,SSL] certificate because of an error: [_1]",e))})):"RequiresApproval"===a.status_code?_.info(i.maketext("The system has canceled the request for this certificate; however, “[_1]” was already waiting on approval before processing your order. To ensure that this certificate order is canceled, you must [output,url,_2,contact support directly].",s,t.support_uri)):"OrderCanceled"===a.status_code?_.info(i.maketext("This certificate’s order (ID “[_1]”) was already canceled directly via “[_2]”.",e.escape(t.order_id),s)):"OrderItemCanceled"===a.status_code?_.info(i.maketext("This certificate (order item ID “[_1]”) was already canceled directly via “[_2]”.",e.escape(t.order_item_id),s)):_.success(i.maketext("The system has canceled this certificate. Your credit card should not be charged for this order.")),CPANEL.PAGE.pending_certificates=null,d.fetch_pending_certificates().then(function(){r.pending_certificates=d.get_pending_certificates(),0===r.pending_certificates.length?r.get_new_certs():r.prepare_pending_certificates()},function(e){_.error(i.maketext("The system encountered an error as it attempted to refresh your pending certificates: [_1]",e))})},function(e){_.error(i.maketext("The system encountered an error as it attempted to cancel your transaction: [_1]",e))})},r.get_displayed_domains=function(e){var t=e.domains;e.displayed_domains=[],e.display_meta.start=e.display_meta.items_per_page*(e.display_meta.current_page-1),e.display_meta.limit=Math.min(t.length,e.display_meta.start+e.display_meta.items_per_page);for(var i=e.display_meta.start;i<e.display_meta.limit;i++)e.displayed_domains.push(t[i]);return e.displayed_domains},r.get_cert_status=function(e){var t=f(e.last_status_code,e.provider);if(t)return t;var r=e.status;return i.maketext("unconfirmed"===r?"Pending Completion of Payment":"confirmed"===r?"Payment Completed. Waiting for the provider to issue the certificate …":"Status Unknown")},r.toggle_cert_collapse=function(e){r.expanded_cert===e.order_item_id?r.collapse_cert(e):r.expand_cert(e)},r.expand_cert=function(e){n.path("/pending-certificates/"+e.order_item_id),r.expanded_cert=e.order_item_id,o(r.expanded_cert)},r.collapse_cert=function(){n.path("/pending-certificates"),r.expanded_cert=null},r.continue_purchase=function(e){var i=d.get_all_domains();d.reset_purchasing_certificates();var r=new l,a=[],o=d.get_product_by_id(e.provider,e.product_id),s=0;r.set_domains(a),r.set_virtual_hosts(e.vhost_names),r.set_product(o),t.forEach(e.domains,function(e){t.forEach(i,function(t){t.domain===e&&(a.push(t),s+=t.is_wildcard?o.wildcard_price:o.price)})}),r.set_price(s),d.add_new_certificate(r),d.save(),n.path("/purchase/"+e.provider+"/login/").search({order_id:e.order_id})},r.rebuild_local_storage=function(){var e={},i=d.get_all_domains(),n=d.get_virtual_hosts();t.forEach(r.pending_certificates,function(r){e[r.order_id]=e[r.order_id]||{access_token:"",certificates:[],order_id:r.order_id,checkout_url:r.checkout_url},e[r.order_id].certificates.push(r),t.forEach(r.domains,function(e){t.forEach(i,function(t){t.domain===e&&(t.selected=!0)})}),t.forEach(r.vhost_names,function(e){var t=d.get_virtual_host_by_display_name(e),i=n[t],a=d.get_product_by_id(r.provider,r.product_id);i&&i.set_product(a)})}),t.forEach(e,function(e){d.add_order(e)}),d.save()},r.restore_orders=function(){d.clear_stored_settings();var t=d.fetch_domains();e.isFunction(t["finally"])?t.then(r.rebuild_local_storage):t&&r.rebuild_local_storage()},r.prepare_pending_certificates=function(){r.pending_certificates.forEach(function(e){e.support_uri_is_http=/^http/.test(e.support_uri),e.display_meta=e.display_meta||{items_per_page:10,current_page:1}})},r.init=function(){r.restore_orders(),r.prepare_pending_certificates(),a.orderitemid&&(r.expanded_cert=a.orderitemid,s(function(){o(r.expanded_cert)},500))},r.init()}var n=t.module("App");n.controller("PendingCertificatesController",["$scope","$location","$routeParams","$anchorScroll","$timeout","$window","CertificatesService","growl","LocationService","Certificate",r])}),define("app/directives/identityVerificationDirective",["angular","cjt/util/locale"],function(e,t){"use strict";function i(e){return!(e.type in d)}function r(e){return c[e.type]?e.type:"text"}function n(){var e=new Date,i=e.toISOString().replace(/T.*/,"");return t.maketext("Use the format “[_1]”. For example, today is “[_2]”.","YYYY-MM-DD",i)}var a;try{a=e.module("App")}catch(o){a=e.module("App",[])}var s="directives/identityVerification.phtml",c={date:!0,number:!0,email:!0,tel:!0},d={country_code:!0,choose_one:!0},_={required:t.maketext("Required"),preamble:t.maketext("To ensure quick service, fill out the form below as completely as possible.")};a.directive("identityVerification",[function(){return{templateUrl:s,restrict:"E",scope:{items:"=",models:"=",countries:"=",vhostName:"="},link:function(t){e.extend(t,{SELF:t,STR:_,get_html_input_type:r,use_html_input:i,get_date_format_description:n}),t.items.forEach(function(e){e.is_optional=Boolean(+e.is_optional)})}}}])}),define("app/index",["angular","cjt/core","lodash","cjt/modules","uiBootstrap","ngRoute","ngSanitize"],function(e,t,i){"use strict";return function(){e.module("App",["ui.bootstrap","angular-growl","cjt2.cpanel"]);var r=require(["cjt/bootstrap","app/services/CertificatesService","app/services/LocationService","app/views/VirtualHostsController","app/views/PurchaseSimpleController","app/views/CheckoutController","app/views/PendingCertificatesController","app/directives/identityVerificationDirective","cjt/decorators/growlDecorator","cjt/services/cpanel/componentSettingSaverService"],function(r){var n=e.module("App");n.value("PAGE",CPANEL.PAGE),n.controller("BaseController",["componentSettingSaverService","CertificatesService","$rootScope","$scope","$route","$location",function(e,t,i,r,n,a){var o="IntroductionBlock";r.loading=!1,i.$on("$routeChangeStart",function(e,t,i){i&&t.loadedTemplateURL===i.loadedTemplateURL||(r.loading=!0)}),i.$on("$routeChangeSuccess",function(){r.loading=!1}),i.$on("$routeChangeError",function(){r.loading=!1}),r.introduction_dismissed=function(){e.set(o,{hidden:!0}),t.dismiss_introduction()},r.current_route_matches=function(e){return a.path().match(e)},r.go=function(e){a.path(e)};var s=e.register(o);s&&s.then(function(e){e&&e.hidden&&t.dismiss_introduction()}),r.$on("$destroy",function(){e.unregister(o)})}]),n.config(["$routeProvider","growlProvider",function(e,r){r.globalPosition("top-right"),e.when("/create-advanced/:domain?",{controller:"VirtualHostsController",templateUrl:t.buildFullPath("security/tls_wizard/views/virtual_hosts.html.tt"),resolve:{installed_hosts:["CertificatesService",function(e){return e.fetch_installed_hosts()}],products:["CertificatesService",function(e){return e.fetch_products()}],domains:["CertificatesService",function(e){return e.fetch_domains()}],pending_certificates:["CertificatesService",function(e){return e.fetch_pending_certificates()}]}}),e.when("/create/:domain?",{controller:"PurchaseSimpleController",templateUrl:t.buildFullPath("security/tls_wizard/views/purchase_simple.html.tt"),resolve:{installed_hosts:["CertificatesService",function(e){return e.fetch_installed_hosts()}],products:["CertificatesService",function(e){return e.fetch_products()}],domains:["CertificatesService",function(e){return e.fetch_domains()}],pending_certificates:["CertificatesService",function(e){return e.fetch_pending_certificates()}]}}),e.when("/pending-certificates/:orderitemid?",{controller:"PendingCertificatesController",templateUrl:t.buildFullPath("security/tls_wizard/views/pending_certificates.html.tt"),resolve:{installed_hosts:["CertificatesService",function(e){return e.fetch_installed_hosts()}],pending_certificates:["CertificatesService","LocationService","$location",function(e,t){var r=e.fetch_pending_certificates();return i.isFunction(r["finally"])?r.then(function(){return e.get_pending_certificates().length?!0:(t.go_to_last_create_route(),!1)}):e.get_pending_certificates().length?!0:(t.go_to_last_create_route(),!1)}],products:["CertificatesService",function(e){return e.fetch_products()}]}}),e.when("/purchase/:provider?/:step?/:everythingelse?",{controller:"CheckoutController",templateUrl:t.buildFullPath("security/tls_wizard/views/checkout.html.tt"),resolve:{products:["CertificatesService",function(e){return e.fetch_products()}]}}),e.otherwise({redirectTo:"/pending-certificates"})}]),r("#content","App")});return r}});