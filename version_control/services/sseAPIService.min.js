define(["angular","lodash"],function(angular,_){"use strict";var app=angular.module("cpanel.versionControl.sseAPIService",[]);app.factory("sseAPIService",["$rootScope",function($rootScope){var _formatData=function(config,data){if(config&&config.json&&data){data=JSON.parse(data)}return data};var _sendFormatErrorEvent=function(eventName,exception,data){$rootScope.$broadcast("sse:"+eventName+":error",{data:data,error:exception})};var makeHandler=function(eventName,config){return function(e){e.eventName=eventName;var data=e.data;try{data=_formatData(config,data)}catch(exception){_sendFormatErrorEvent(eventName,exception,data);return}$rootScope.$broadcast("sse:"+eventName,data)}};var connect=function connect(url,events,config){if(!events){events=[]}var sseConfig=config||{};var sse=new EventSource(url);if(events){events.forEach(function(event){sse.addEventListener(event,makeHandler(event,sseConfig))})}sse.onerror=function(e){$rootScope.$broadcast("sse:error",e)};window.addEventListener("beforeunload",function(e){if(sse){sse.close();sse=null;$rootScope.$broadcast("sse:beforeunload",e)}});return sse};var initialize=function initialize(ready){if(!window.EventSource){var script=document.createElement("script");script.src="/libraries/eventsource-polyfill/eventsource.js";script.onload=function(){if(ready){ready()}$rootScope.$broadcast("sse:ready")};document.body.appendChild(script)}else{if(ready){ready()}$rootScope.$broadcast("sse:ready")}};var close=function(sse){if(sse){sse.close()}};return{initialize:initialize,connect:connect,close:close}}])});