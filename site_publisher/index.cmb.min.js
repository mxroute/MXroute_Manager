define("app/services/publishService",["angular","cjt/io/api","cjt/io/uapi-request","cjt/io/uapi"],function(e,t,a){function r(r){var i={};return i.convertResponseToList=function(t){var a=[];if(t.data){for(var r=t.data,i=0,n=r.length;n>i;i++)a.push(r[i]);var o=t.meta||{};return e.isDefined(o.paginate)||(o.paginate={total_records:r.length,total_pages:1}),e.isDefined(o.records_before_filter)||(o.records_before_filter=r.length),{meta:o,data:a}}return{meta:{paginate:{total_records:0,total_pages:0}},data:[]}},i.listDomains=function(e){var i=r.defer(),n=new a.Class;return n.initialize("SiteTemplates","list_user_settings"),e&&(e.currentPage&&n.addPaging(e.currentPage,e.pageSize||10),e.filterBy&&e.filterCompare&&e.filterValue&&n.addFilter(e.filterBy,e.filterCompare,e.filterValue)),t.promise(n.getRunArguments()).done(function(e){e=e.parsedResponse,e.status?i.resolve(e):i.reject(e.error)}),i.promise},i.publish=function(e,i){var n=r.defer(),o=new a.Class,s=_.map(e.meta.fields,function(e){if(e.value&&0===e.type.indexOf("date",0)){if("Invalid Date"===e.value.toString())return{id:e.id,value:""};try{return{id:e.id,value:new Date(e.value).toISOString()}}catch(t){return{id:e.id,value:""}}}return _.pick(e,["id","value"])});o.initialize("SiteTemplates","publish"),o.addArgument("path",e.path),o.addArgument("template",e.template),o.addArgument("docroot",i.documentroot),o.addArgument("domain_url",i.url);for(var l=0,u=s.length;u>l;l++)o.addArgument(s[l].id,s[l].value);return t.promise(o.getRunArguments()).done(function(e){e=e.parsedResponse,e.status?n.resolve(e):n.reject(e.error)}),n.promise},i}var i=e.module("App");return r.$inject=["$q"],i.factory("publishService",r)}),define("app/views/publishController",["angular","cjt/util/locale","uiBootstrap","cjt/filters/wrapFilter","cjt/directives/actionButtonDirective","cjt/directives/jsonFieldDirective","cjt/decorators/growlDecorator","app/services/publishService"],function(e,t){function a(e){e.decorator("$exceptionHandler",["$injector",function(e){return function(a){e.get("growl").error(t.maketext("A problem has occurred: [_1]",a.message))}}])}var r=e.module("App"),i=r.controller("publishController",["$scope","publishService","$timeout","alertService","growl","$q",function(a,i,n,o,s,l){a.domainList=[],a.templateList=[],a.meta={filterBy:"*",filterCompare:"contains",filterValue:"",maxPages:0,totalItems:a.domainList.length,currentPage:1,pageSize:10,pageSizes:[10,20,50,100],start:0,limit:10};var u=function(){for(var e=0,t=a.templateList.length;t>e;e++)delete a.templateList[e].selected},m=function(){for(var e=0,t=a.domainList.length;t>e;e++)delete a.domainList[e].selected};a.resetSteps=function(){a.status={isDomainSelectOpen:!0,isDomainSelectStep:!0,isTemplateSelectOpen:!1,isTemplateSelectStep:!1,isTemplateFormOpen:!1,isTemplateFormStep:!1,isPublished:!1},a.selectedDomain=null,m(),a.selectedTemplate=null,u()},a.getPanelClass=function(e){var t="panel-default",r="panel-primary";return"domain"===e&&a.status.isDomainSelectStep?t=r:"template"===e&&a.status.isTemplateSelectStep?t=r:"publish"===e&&a.status.isTemplateFormStep&&(t=r),t};var p=function(e){var t=e.data;a.meta.totalItems=e.meta.paginate.total_records,a.meta.records_before_filter=e.meta.records_before_filter;var r=t;if(a.meta.totalItems>_.min(a.meta.pageSizes)){var i=(a.meta.currentPage-1)*a.meta.pageSize;a.showPager=!0,a.meta.start=i+1,a.meta.limit=i+r.length}else a.showPager=!1,a.meta.start=0===r.length?0:1,a.meta.limit=r.length;if(a.selectedDomain)for(var n=0,o=r.length;o>n;n++)if(r[n].domain===a.selectedDomain.domain){r[n].selected=!0;break}a.domainList=r,1===a.meta.records_before_filter&&a.selectDomain(0)},c=function(){i.listDomains(a.meta).then(function(e){p(e)},function(e){s.error(e)})};a.clearFilter=function(){return a.meta.filterValue="",a.selectPage(1)},a.selectPage=function(t){return t&&e.isNumber(t)&&(a.meta.currentPage=t),c()},a.getSiteAddress=function(e){return"http://"+e.domain},a.getFileManagerLink=function(e){if(e){var t=e.documentroot.slice(e.homedir.length+1);return a.deprefix+a.fileManagerObj.url+"?dir="+encodeURIComponent(t)}return a.fileManagerObj.url},a.selectDomain=function(e){if(a.selectedDomain=a.domainList[e],m(),a.domainList[e].selected=!0,a.status.isDomainSelectOpen=a.status.isDomainSelectStep=!1,a.status.isTemplateSelectOpen=a.status.isTemplateSelectStep=!0,a.status.isTemplateFormOpen=a.status.isTemplateFormStep=!1,u(),a.selectedDomain.template_settings.hasOwnProperty("template"))for(var t=0,r=a.templateList.length;r>t;t++){var i=a.templateList[t];if(a.selectedDomain.template_settings.template===i.template){i.selected=!0;break}}a.selectedTemplate=!1,a.status.isPublished=!1,1===a.templateList.length&&a.selectTemplate(0)},a.selectTemplate=function(e){a.selectedTemplate=a.templateList[e],u(),a.templateList[e].selected=!0;for(var t=0,r=a.templateList[e].meta.fields.length;r>t;t++){var i=a.templateList[e].meta.fields[t];a.selectedDomain.template_settings.hasOwnProperty(i.id)&&(i.value=a.selectedDomain.template_settings[i.id])}a.status.isTemplateSelectOpen=a.status.isTemplateSelectStep=!1,a.status.isTemplateFormOpen=a.status.isTemplateFormStep=!0,a.status.isPublished=!1},a.hasError=function(e){var t=document.publish_form;return t.hasOwnProperty(e.name)&&"function"==typeof t[e.name].checkValidity?!t[e.name].checkValidity():!1},a.publishTemplate=function(e,r){var n=document.publish_form.getElementsByClassName("has-error").length;return n?(s.error(t.maketext("The form has returned [quant,_1,error,errors]",n)),l.when(!1)):(r.url=a.getSiteAddress(r),i.publish(e,r).then(function(){a.status.isTemplateFormOpen=a.status.isTemplateFormStep=!1,a.status.isPublished=!0,r.template_settings={is_empty:0,path:e.path,template:e.template,docroot:r.documentroot};for(var t=0,i=e.meta.fields.length;i>t;t++){var n=e.meta.fields[t];r.template_settings[n.id]=n.value}},function(e){s.error(e)}))};var d=function(){a.locale=t,a.resetSteps(),PAGE.deprefix&&(a.deprefix=PAGE.deprefix),PAGE.fileManagerObj&&(a.fileManagerObj=PAGE.fileManagerObj),PAGE.accountsObj&&(a.accountsObj=PAGE.accountsObj),PAGE.webdiskObj&&(a.webdiskObj=PAGE.webdiskObj),r.firstLoad.publish&&PAGE.domainList&&PAGE.templateList?(r.firstLoad.publish=!1,a.templateList=i.convertResponseToList(PAGE.templateList).data.sort(function(e,t){var a,r,i,n;return e.meta.information.hasOwnProperty("date")?(a=Date.parse(e.meta.information.date),isNaN(a)&&(a=0)):a=0,t.meta.information.hasOwnProperty("date")?(r=Date.parse(t.meta.information.date),isNaN(r)&&(r=0)):r=0,r>a?1:a>r?-1:(i=e.meta.information.hasOwnProperty("name")&&null!==e.meta.information.name?e.meta.information.name.toLowerCase():"",n=t.meta.information.hasOwnProperty("name")&&null!==t.meta.information.name?t.meta.information.name.toLowerCase():"",i>n?1:n>i?-1:0)}),p(i.convertResponseToList(PAGE.domainList))):c()};d()}]);return a.$inject=["$provide"],r.config(a),i}),define("app/index",["angular","cjt/core","cjt/modules","ngRoute","uiBootstrap"],function(e,t){return function(){e.module("App",["ngRoute","ui.bootstrap","angular-growl","cjt2.cpanel"]);var a=require(["cjt/bootstrap","uiBootstrap","cjt/views/applicationController","app/views/publishController"],function(a){var r=e.module("App");r.firstLoad={publish:!0},r.value("PAGE",CPANEL.PAGE),r.controller("BaseController",["$rootScope","$scope","$route","$location",function(e,t,a,r){t.loading=!1,e.$on("$routeChangeStart",function(){t.loading=!0}),e.$on("$routeChangeSuccess",function(){t.loading=!1}),e.$on("$routeChangeError",function(){t.loading=!1}),t.current_route_matches=function(e){return r.path().match(e)},t.go=function(e){r.path(e)}}]),r.config(["$routeProvider","$locationProvider",function(e){e.when("/publish",{controller:"publishController",templateUrl:t.buildFullPath("site_publisher/views/publishView.html.tt"),resolve:{}}),e.otherwise({redirectTo:"/publish"})}]),a("#content","App")});return a}});