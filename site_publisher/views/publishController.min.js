define(["angular","cjt/util/locale","uiBootstrap","cjt/filters/wrapFilter","cjt/directives/actionButtonDirective","cjt/directives/jsonFieldDirective","cjt/decorators/growlDecorator","app/services/publishService"],function(angular,LOCALE){"use strict";var app=angular.module("App");var controller=app.controller("publishController",["$scope","$routeParams","publishService","$timeout","alertService","growl","$q",function($scope,$routeParams,publishService,$timeout,alertService,growl,$q){$scope.domainList=[];$scope.templateList=[];$scope.meta={filterBy:"*",filterCompare:"contains",filterValue:"",maxPages:0,totalItems:$scope.domainList.length,currentPage:1,pageSize:10,pageSizes:[10,20,50,100],start:0,limit:10};var clearSelectedTemplate=function(){for(var i=0,length=$scope.templateList.length;i<length;i++){delete $scope.templateList[i].selected}};var clearSelectedDomain=function(){for(var i=0,length=$scope.domainList.length;i<length;i++){delete $scope.domainList[i].selected}};$scope.resetSteps=function(){$scope.status={isDomainSelectOpen:true,isDomainSelectStep:true,isTemplateSelectOpen:false,isTemplateSelectStep:false,isTemplateFormOpen:false,isTemplateFormStep:false,isPublished:false};$scope.selectedDomain=null;clearSelectedDomain();$scope.selectedTemplate=null;clearSelectedTemplate()};$scope.getPanelClass=function(step){var panelClass="panel-default",activeClass="panel-primary";if(step==="domain"&&$scope.status.isDomainSelectStep){panelClass=activeClass}else if(step==="template"&&$scope.status.isTemplateSelectStep){panelClass=activeClass}else if(step==="publish"&&$scope.status.isTemplateFormStep){panelClass=activeClass}return panelClass};var processDomainList=function(resultList){var domainList=resultList.data;$scope.meta.totalItems=resultList.meta.paginate.total_records;$scope.meta.records_before_filter=resultList.meta.records_before_filter;var filteredList=domainList;if($scope.meta.totalItems>_.min($scope.meta.pageSizes)){var start=($scope.meta.currentPage-1)*$scope.meta.pageSize;$scope.showPager=true;$scope.meta.start=start+1;$scope.meta.limit=start+filteredList.length}else{$scope.showPager=false;if(filteredList.length===0){$scope.meta.start=0}else{$scope.meta.start=1}$scope.meta.limit=filteredList.length}if($scope.selectedDomain){for(var i=0,length=filteredList.length;i<length;i++){if(filteredList[i].domain===$scope.selectedDomain.domain){filteredList[i].selected=true;break}}}$scope.domainList=filteredList;if($scope.meta.records_before_filter===1){$scope.selectDomain(0)}};var fetchDomainsList=function(){return publishService.listDomains($scope.meta).then(function(response){processDomainList(response)},function(error){growl.error(error)})};$scope.clearFilter=function(){$scope.meta.filterValue="";return $scope.selectPage(1)};$scope.selectPage=function(page){if(page&&angular.isNumber(page)){$scope.meta.currentPage=page}return fetchDomainsList()};$scope.getSiteAddress=function(domain){return"//"+domain.domain};$scope.getFileManagerLink=function(domain){if(domain){var docroot=domain.documentroot.slice(domain.homedir.length+1);return $scope.deprefix+$scope.fileManagerObj.url+"?dir="+encodeURIComponent(docroot)}else{return $scope.fileManagerObj.url}};$scope.selectDomain=function(id){$scope.selectedDomain=$scope.domainList[id];clearSelectedDomain();$scope.domainList[id].selected=true;$scope.status.isDomainSelectOpen=$scope.status.isDomainSelectStep=false;$scope.status.isTemplateSelectOpen=$scope.status.isTemplateSelectStep=true;$scope.status.isTemplateFormOpen=$scope.status.isTemplateFormStep=false;clearSelectedTemplate();if($scope.selectedDomain.template_settings.hasOwnProperty("template")){for(var i=0,length=$scope.templateList.length;i<length;i++){var template=$scope.templateList[i];if($scope.selectedDomain.template_settings.template===template.template){template.selected=true;break}}}$scope.selectedTemplate=false;$scope.status.isPublished=false;if($scope.templateList.length===1){$scope.selectTemplate(0)}};$scope.selectTemplate=function(id){$scope.selectedTemplate=$scope.templateList[id];clearSelectedTemplate();$scope.templateList[id].selected=true;for(var i=0,length=$scope.templateList[id].meta.fields.length;i<length;i++){var field=$scope.templateList[id].meta.fields[i];if($scope.selectedDomain.template_settings.hasOwnProperty(field.id)){field.value=$scope.selectedDomain.template_settings[field.id]}}$scope.status.isTemplateSelectOpen=$scope.status.isTemplateSelectStep=false;$scope.status.isTemplateFormOpen=$scope.status.isTemplateFormStep=true;$scope.status.isPublished=false};$scope.hasError=function(field){var form=document.publish_form;if(form.hasOwnProperty(field.name)&&typeof form[field.name].checkValidity==="function"){return!form[field.name].checkValidity()}return false};$scope.publishTemplate=function(template,domain){var errorCount=document.publish_form.getElementsByClassName("has-error").length;if(errorCount){growl.error(LOCALE.maketext("The form has returned [quant,_1,error,errors]",errorCount));return $q.when(false)}domain.url=$scope.getSiteAddress(domain);return publishService.publish(template,domain).then(function(){$scope.status.isTemplateFormOpen=$scope.status.isTemplateFormStep=false;$scope.status.isPublished=true;domain.template_settings={is_empty:0,path:template.path,template:template.template,docroot:domain.documentroot};for(var i=0,length=template.meta.fields.length;i<length;i++){var field=template.meta.fields[i];domain.template_settings[field.id]=field.value}},function(error){growl.error(error)})};var _initializeView=function(){$scope.locale=LOCALE;$scope.resetSteps();if(PAGE.deprefix){$scope.deprefix=PAGE.deprefix}if(PAGE.fileManagerObj){$scope.fileManagerObj=PAGE.fileManagerObj}if(PAGE.accountsObj){$scope.accountsObj=PAGE.accountsObj}if(PAGE.webdiskObj){$scope.webdiskObj=PAGE.webdiskObj}if(app.firstLoad.publish&&PAGE.domainList&&PAGE.templateList){app.firstLoad.publish=false;$scope.templateList=publishService.convertResponseToList(PAGE.templateList).data.sort(function(a,b){var aDate,bDate,aName,bName;if(a.meta.information.hasOwnProperty("date")){aDate=Date.parse(a.meta.information.date);if(isNaN(aDate)){aDate=0}}else{aDate=0}if(b.meta.information.hasOwnProperty("date")){bDate=Date.parse(b.meta.information.date);if(isNaN(bDate)){bDate=0}}else{bDate=0}if(bDate>aDate){return 1}else if(bDate<aDate){return-1}else{if(a.meta.information.hasOwnProperty("name")&&a.meta.information.name!==null){aName=a.meta.information.name.toLowerCase()}else{aName=""}if(b.meta.information.hasOwnProperty("name")&&b.meta.information.name!==null){bName=b.meta.information.name.toLowerCase()}else{bName=""}return aName>bName?1:aName<bName?-1:0}});processDomainList(publishService.convertResponseToList(PAGE.domainList))}else{fetchDomainsList()}if($routeParams["domain"]){$scope.meta.filterValue=$routeParams["domain"];$scope.selectPage(1).then(function(){$scope.domainList.forEach(function(domain,key){if(domain.domain===$routeParams["domain"]){$scope.selectDomain(key)}})})}};_initializeView()}]);function ExceptionHandler($provide){$provide.decorator("$exceptionHandler",["$injector",function($injector){return function(exception){$injector.get("growl").error(LOCALE.maketext("A problem has occurred: [_1]",exception.message))}}])}ExceptionHandler.$inject=["$provide"];app.config(ExceptionHandler);return controller});